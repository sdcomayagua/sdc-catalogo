const TESTIMONIALS_SHEET = "testimonios";
let testimonials = [];

function resolveAvatarColor(value) {
  const v = String(value || "").trim().toLowerCase();
  if (v === "primary") return "var(--primary)";
  if (v === "accent") return "var(--accent)";
  if (v) return value; // hex o cualquier color válido
  return "var(--primary)";
}

function makeInitials(name) {
  const parts = String(name || "").trim().split(/\s+/).filter(Boolean);
  if (parts.length === 0) return "SD";
  const a = parts[0][0] || "";
  const b = parts[1] ? (parts[1][0] || "") : "";
  return (a + b).toUpperCase();
}

function fetchTestimonials() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(TESTIMONIALS_SHEET)}`;

  fetch(url)
    .then(r => r.text())
    .then(t => {
      const json = JSON.parse(t.substring(47, t.length - 2));
      const cols = json.table.cols.map(c =>
        c && c.label
          ? c.label.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          : "col"
      );

      testimonials = json.table.rows.map(r => {
        let obj = {};
        r.c.forEach((c, i) => obj[cols[i]] = c ? (c.v === null ? "" : c.v) : "");
        return obj;
      }).filter(x => x.nombre && (x.comentario || x.texto));

      // normalizar y ordenar
      testimonials = testimonials.map(x => ({
        nombre: String(x.nombre || "").trim(),
        rol: String(x.rol || "Cliente").trim(),
        comentario: String(x.comentario || x.texto || "").trim(),
        estrellas: Math.max(1, Math.min(5, parseInt(x.estrellas || "5", 10) || 5)),
        iniciales: String(x.iniciales || "").trim(),
        color: String(x.color || "").trim(),
        orden: parseInt(x.orden || "9999", 10) || 9999
      })).sort((a,b) => a.orden - b.orden);

      renderTestimonials();
    })
    .catch(() => {
      // Si no existe la hoja o no hay acceso
      const track = document.getElementById("testimonialsTrack");
      if (track) {
        track.innerHTML = `<div class="t-card"><p class="t-text">Aún no hay testimonios cargados.</p></div>`;
      }
    });
}

function renderTestimonials() {
  const track = document.getElementById("testimonialsTrack");
  if (!track) return;

  track.innerHTML = "";

  if (!testimonials.length) {
    track.innerHTML = `<div class="t-card"><p class="t-text">Aún no hay testimonios.</p></div>`;
    return;
  }

  testimonials.forEach((t, idx) => {
    const card = document.createElement("div");
    card.className = "t-card";

    const avatarColor = resolveAvatarColor(t.color) || (idx % 2 === 0 ? "var(--primary)" : "var(--accent)");
    const initials = t.iniciales ? t.iniciales.toUpperCase() : makeInitials(t.nombre);

    // Header
    const header = document.createElement("div");
    header.className = "t-header";

    const avatar = document.createElement("div");
    avatar.className = "t-avatar";
    avatar.style.background = avatarColor;
    avatar.textContent = initials;

    const info = document.createElement("div");
    info.className = "t-info";

    const h4 = document.createElement("h4");
    h4.textContent = t.nombre;

    const span = document.createElement("span");
    span.textContent = t.rol;

    info.appendChild(h4);
    info.appendChild(span);

    header.appendChild(avatar);
    header.appendChild(info);

    // Stars
    const stars = document.createElement("div");
    stars.className = "t-stars";
    for (let i = 0; i < t.estrellas; i++) {
      const star = document.createElement("i");
      star.className = "fa-solid fa-star";
      stars.appendChild(star);
    }

    // Text
    const text = document.createElement("p");
    text.className = "t-text";
    text.textContent = `"${t.comentario}"`;

    card.appendChild(header);
    card.appendChild(stars);
    card.appendChild(text);

    track.appendChild(card);
  });
}
