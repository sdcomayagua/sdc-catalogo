<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0b1220" />
  <title>Cat√°logo SDC - 2026</title>

  <!-- ‚úÖ Si tienes tu logo en /img/logo.png, se mostrar√° autom√°ticamente -->
  <link rel="icon" href="img/logo.png" />

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#6b7280;
      --line:#e5e7eb;
      --primary:#1d4ed8;
      --primary2:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
      --shadow:0 10px 30px rgba(2,6,23,.10);
      --radius:16px;
      --radius2:12px;
    }
    body.dark{
      --bg:#070b12;
      --card:#0c1220;
      --text:#e8eefc;
      --muted:#9aa6bd;
      --line:#1e2a44;
      --primary:#60a5fa;
      --primary2:#3b82f6;
      --danger:#ef4444;
      --ok:#22c55e;
      --shadow:0 10px 30px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    /* ‚úÖ HEADER (m√°s peque√±o y limpio) */
    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,0)) , var(--bg);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 14px;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      max-width:1100px;
      margin:0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .brand img{
      height:36px; width:36px; object-fit:cover;
      border-radius:10px;
      border:1px solid var(--line);
      background:var(--card);
      pointer-events:none;
    }
    .brand .txt{min-width:0}
    .brand h1{
      margin:0;
      font-size:14px;             /* ‚úÖ m√°s peque√±o */
      font-weight:900;
      letter-spacing:.6px;
      text-transform:uppercase;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:56vw;
    }
    .brand p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:56vw;
    }

    .actions{
      display:flex; align-items:center; gap:8px;
      flex-shrink:0;
    }
    .iconBtn{
      display:inline-flex; align-items:center; justify-content:center;
      width:40px; height:40px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      box-shadow: 0 4px 12px rgba(2,6,23,.06);
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:active{transform:scale(.98)}
    .iconBtn svg{display:block}
    .badge{
      position:absolute;
      top:-6px; right:-6px;
      background:var(--danger);
      color:#fff;
      font-weight:800;
      font-size:11px;
      min-width:18px; height:18px;
      padding:0 5px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      border:2px solid var(--bg);
    }

    /* ‚úÖ TABS */
    .tabsWrap{
      max-width:1100px;
      margin:10px auto 0;
      padding:0 2px;
    }
    .tabs{
      display:flex;
      gap:8px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding:6px 0 8px;
      scrollbar-width:thin;
    }
    .tab{
      flex:0 0 auto;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding:8px 12px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;          /* ‚úÖ sin saltos de l√≠nea */
      user-select:none;
      box-shadow: 0 4px 14px rgba(2,6,23,.06);
    }
    .tab.active{
      border-color: rgba(37,99,235,.45);
      background: rgba(37,99,235,.12);
      color:var(--text);
    }

    main{
      max-width:1100px;
      margin:14px auto 120px;
      padding:0 14px;
    }

    .metaRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin:6px 0 12px;
      color:var(--muted);
      font-size:12px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:var(--card);
      color:var(--text);
      box-shadow: 0 4px 14px rgba(2,6,23,.06);
      font-weight:800;
    }

    /* ‚úÖ GRID */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (min-width:720px){
      .grid{grid-template-columns: repeat(3, minmax(0, 1fr));}
    }
    @media (min-width:980px){
      .grid{grid-template-columns: repeat(4, minmax(0, 1fr));}
    }

    .card{
      position:relative;
      border:1px solid var(--line);
      background:var(--card);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height: 290px;
    }
    .imgWrap{
      position:relative;
      width:100%;
      aspect-ratio: 1/1;
      background: rgba(2,6,23,.03);
    }
    body.dark .imgWrap{background: rgba(255,255,255,.03)}
    .imgWrap img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .soldMark{
      position:absolute;
      left:-20%;
      top:35%;
      width:140%;
      transform: rotate(-18deg);
      text-align:center;
      font-weight:1000;
      letter-spacing:2px;
      font-size:28px;
      padding:10px 0;
      color: rgba(255,255,255,.92);
      background: rgba(220,38,38,.78);
      text-shadow: 0 6px 16px rgba(0,0,0,.25);
      border-top:1px solid rgba(255,255,255,.25);
      border-bottom:1px solid rgba(255,255,255,.25);
      pointer-events:none;
    }

    .content{
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:1;
    }
    .title{
      font-size:13px;
      font-weight:900;
      line-height:1.25;
      margin:0;
      color:var(--text);
      min-height: 34px;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      margin:-2px 0 0;
      min-height:16px;
    }
    .priceRow{
      display:flex; align-items:baseline; gap:8px;
    }
    .price{
      font-size:16px;
      font-weight:1000;
      color:var(--text);
    }
    .old{
      font-size:12px;
      color:var(--muted);
      text-decoration: line-through;
    }
    .stockRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:8px;
      margin-top:auto;
    }
    .stock{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    .btn{
      border:none;
      padding:10px 12px;
      border-radius:12px;
      background: linear-gradient(90deg, var(--primary2), var(--primary));
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(37,99,235,.20);
      white-space:nowrap;
    }
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
      box-shadow:none;
    }

    /* ‚úÖ SEARCH OVERLAY */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:100;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(720px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
    }
    .modalHead strong{font-size:13px}
    .modalBody{padding:12px}
    .searchRow{
      display:flex; gap:10px; align-items:center;
    }
    .input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: transparent;
      color:var(--text);
      font-weight:800;
      outline:none;
    }
    .ghost{
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:1000;
      cursor:pointer;
      white-space:nowrap;
    }

    /* ‚úÖ CART BAR */
    .cartBar{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:90;
      border-top:1px solid var(--line);
      background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.03)), var(--bg);
      backdrop-filter: blur(10px);
      padding:10px 14px;
    }
    .cartInner{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cartInner .left{
      display:flex; flex-direction:column;
      gap:2px; min-width:0;
    }
    .cartInner .left b{
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:70vw;
    }
    .cartInner .left span{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    .cartInner .right{
      display:flex; align-items:center; gap:10px; flex-shrink:0;
    }

    /* ‚úÖ TOAST */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:88px;
      z-index:120;
      background:rgba(2,6,23,.92);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      box-shadow: 0 16px 30px rgba(0,0,0,.25);
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    /* ‚úÖ FLOAT WHATSAPP (logo original SVG) */
    .float-ws{
      position:fixed;
      right:16px;
      bottom:92px;
      z-index:95;
      width:54px;
      height:54px;
      border-radius:999px;
      background:#25D366;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 14px 28px rgba(0,0,0,.25);
      border:2px solid rgba(255,255,255,.35);
      text-decoration:none;
    }
    .float-ws:active{transform:scale(.98)}
    .float-ws svg{display:block}

    /* ‚úÖ ‚ÄúCargando / Error‚Äù */
    .centerMsg{
      padding:28px 10px;
      text-align:center;
      color:var(--muted);
      font-weight:900;
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <img src="img/logo.png" alt="Logo" onerror="this.style.display='none'" />
        <div class="txt">
          <h1>Soluciones Digitales Comayagua</h1>
          <p>Cat√°logo SDC - 2026</p>
        </div>
      </div>

      <div class="actions">
        <!-- üîç Buscar -->
        <div class="iconBtn" id="searchToggle" tabindex="0" role="button" aria-label="Buscar">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M10 18a8 8 0 1 1 5.293-14.001A8 8 0 0 1 10 18m11 3-6-6 1.5-1.5 6 6z"/>
          </svg>
        </div>

        <!-- üåó D√≠a / Noche -->
        <div class="iconBtn" id="themeToggle" tabindex="0" role="button" aria-label="D√≠a/Noche">
          <svg id="themeIcon" width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M12 18a6 6 0 1 1 0-12a6 6 0 0 1 0 12M12 2h1v3h-1zm0 17h1v3h-1zM2 11h3v1H2zm17 0h3v1h-3zM4.22 4.22l2.12 2.12-.7.7L3.52 4.92zm13.44 13.44 2.12 2.12-.7.7-2.12-2.12zM19.78 4.22l.7.7-2.12 2.12-.7-.7zM6.34 17.66l.7.7-2.12 2.12-.7-.7z"/>
          </svg>
        </div>

        <!-- üõí Carrito -->
        <div class="iconBtn" id="cartBtn" tabindex="0" role="button" aria-label="Carrito" style="position:relative">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2m10 0c-1.1 0-1.99.9-1.99 2S15.9 22 17 22s2-.9 2-2-.9-2-2-2M7.17 14h9.66c.75 0 1.4-.41 1.74-1.03l3.24-5.88A1 1 0 0 0 21.95 5H6.21L5.27 3H2v2h2l3.6 7.59-1.35 2.44A2 2 0 0 0 8 18h12v-2H8a.25.25 0 0 1-.22-.37z"/>
          </svg>
          <div class="badge" id="cartBadge" style="display:none">0</div>
        </div>
      </div>
    </div>

    <div class="tabsWrap">
      <div class="tabs" id="tabs"></div>
    </div>
  </header>

  <main>
    <div class="metaRow">
      <div class="pill" id="countPill">Cargando‚Ä¶</div>
      <div class="pill" id="statusPill">Conectando a Google Sheets‚Ä¶</div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="centerMsg" class="centerMsg" style="display:none"></div>
  </main>

  <!-- ‚úÖ Search overlay -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Buscar productos">
      <div class="modalHead">
        <strong>üîç Buscar producto</strong>
        <button class="ghost" id="searchClose">Cerrar</button>
      </div>
      <div class="modalBody">
        <div class="searchRow">
          <input class="input" id="searchInput" placeholder="Buscar por nombre o descripci√≥n‚Ä¶" autocomplete="off" />
          <button class="ghost" id="searchClear">Limpiar</button>
        </div>
        <div style="margin-top:10px; color:var(--muted); font-weight:900; font-size:12px">
          Tip: escribe cualquier palabra y ver√°s los resultados filtrados.
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Cart overlay -->
  <div class="overlay" id="cartOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Carrito">
      <div class="modalHead">
        <strong>üõí Tu pedido</strong>
        <button class="ghost" id="cartClose">Cerrar</button>
      </div>
      <div class="modalBody" id="cartBody">
        <!-- Render din√°mico -->
      </div>
    </div>
  </div>

  <!-- ‚úÖ Barra inferior (evita el problema de ‚Äúno se ve ENVIAR PEDIDO‚Äù) -->
  <div class="cartBar">
    <div class="cartInner">
      <div class="left">
        <b id="cartSummary">Carrito vac√≠o</b>
        <span id="cartSub">Agrega productos para enviar tu pedido</span>
      </div>
      <div class="right">
        <button class="ghost" id="openCart">Ver</button>
        <button class="btn" id="sendOrder" disabled>ENVIAR PEDIDO</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ WhatsApp flotante (logo original SVG) -->
  <a class="float-ws" href="https://wa.me/50432429490" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp">
    <svg viewBox="0 0 32 32" width="30" height="30" aria-hidden="true" focusable="false">
      <path fill="#fff" d="M19.11 17.39c-.27-.14-1.6-.79-1.85-.88-.25-.09-.43-.14-.61.14-.18.27-.7.88-.86 1.06-.16.18-.32.2-.59.07-.27-.14-1.14-.42-2.17-1.33-.8-.71-1.34-1.58-1.5-1.85-.16-.27-.02-.42.12-.56.12-.12.27-.32.41-.48.14-.16.18-.27.27-.45.09-.18.05-.34-.02-.48-.07-.14-.61-1.47-.84-2.01-.22-.53-.45-.46-.61-.46h-.52c-.18 0-.48.07-.73.34-.25.27-.95.93-.95 2.27 0 1.34.97 2.64 1.11 2.83.14.18 1.91 2.91 4.62 4.08.65.28 1.15.45 1.55.58.65.21 1.25.18 1.72.11.52-.08 1.6-.65 1.83-1.28.23-.63.23-1.17.16-1.28-.07-.11-.25-.18-.52-.32z"/>
      <path fill="#fff" d="M16.04 3C8.85 3 3 8.74 3 15.8c0 2.43.7 4.8 2.03 6.84L4 29l6.54-2.03c1.97 1.07 4.2 1.63 6.5 1.63C23.23 28.6 29 22.86 29 15.8 29 8.74 23.23 3 16.04 3zm0 23.2c-2.08 0-4.09-.54-5.84-1.56l-.42-.24-3.88 1.2 1.26-3.73-.27-.4a10.38 10.38 0 0 1-1.69-5.67c0-5.75 4.78-10.42 10.84-10.42 6.06 0 10.84 4.67 10.84 10.42 0 5.75-4.78 10.4-10.84 10.4z"/>
    </svg>
  </a>

  <div class="toast" id="toast"></div>

  <script>
    /**********************************************************************
     * ‚úÖ CONFIG (NO CAMBIAR)
     **********************************************************************/
    const SHEET_ID = "1p0PFCH-JWG9bQLeIh-6LgdMV7meHFa3KzIhNW9Xz3JE"; // ‚úÖ tu ID
    const STATE_KEY = "sdc_catalog_state_v6";
    const CART_KEY  = "sdc_catalog_cart_v3";
    const DEFAULT_SHEETS = ["ofertas","gamer","pc","movil","streaming","cobertores","power"]; // fallback

    /**********************************************************************
     * ‚úÖ STATE / THEME
     **********************************************************************/
    let dark = false;
    function loadState(){
      try{return JSON.parse(localStorage.getItem(STATE_KEY) || "{}");}catch(e){return {};}
    }
    function saveState(){
      const st = loadState();
      st.dark = !!dark;
      st.cat = DB.activeCategory;
      st.q = DB.query;
      localStorage.setItem(STATE_KEY, JSON.stringify(st));
    }
    function applyTheme(isDark){
      dark = !!isDark;
      document.body.classList.toggle("dark", dark);
      // Icon swap (sol/luna)
      const icon = document.getElementById("themeIcon");
      if(icon){
        icon.innerHTML = dark
          ? '<path fill="currentColor" d="M12 3a7 7 0 0 0 0 14a7.3 7.3 0 0 0 7-7.6A7.2 7.2 0 0 1 12 3Z"/>'
          : '<path fill="currentColor" d="M12 18a6 6 0 1 1 0-12a6 6 0 0 1 0 12M12 2h1v3h-1zm0 17h1v3h-1zM2 11h3v1H2zm17 0h3v1h-3zM4.22 4.22l2.12 2.12-.7.7L3.52 4.92zm13.44 13.44 2.12 2.12-.7.7-2.12-2.12zM19.78 4.22l.7.7-2.12 2.12-.7-.7zM6.34 17.66l.7.7-2.12 2.12-.7-.7z"/>'
      }
    }

    /**********************************************************************
     * ‚úÖ UI HELPERS
     **********************************************************************/
    const $ = (id)=>document.getElementById(id);
    const toastEl = $("toast");
    let toastT = null;
    function toast(msg){
      if(!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastT);
      toastT = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }
    function setCenterMsg(msg){
      const el = $("centerMsg");
      if(!el) return;
      el.style.display = msg ? "block" : "none";
      el.textContent = msg || "";
    }
    function showFatal(msg){
      setCenterMsg(msg);
      $("grid").innerHTML = "";
    }

    /**********************************************************************
     * ‚úÖ DATA MODEL
     **********************************************************************/
    const DB = {
      sheets: [],
      products: [],
      activeCategory: "Todas",
      query: "",
      shipping: [],
      cart: {}, // id -> qty
    };

    function normalizeHeader(h){
      return String(h||"").trim().toLowerCase()
        .replace(/\s+/g,"_")
        .replace(/[^\w√°√©√≠√≥√∫√±_]/gi,"");
    }
    function toNumber(v){
      const s = String(v ?? "").replace(/[^\d.,-]/g,"").replace(",",".");
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }
    function safeStr(v){ return (v==null) ? "" : String(v).trim(); }
    function makeId(p){
      return (
        safeStr(p.categoria)+"|"+
        safeStr(p.nombre)+"|"+
        safeStr(p.precio)
      ).toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9√°√©√≠√≥√∫√±\-|]/gi,"");
    }

    /**********************************************************************
     * ‚úÖ GOOGLE SHEETS FETCH (GVIZ) + Auto sheet list (si est√° publicado)
     **********************************************************************/
    async function fetchSheetNames(){
      // Intenta detectar hojas autom√°ticamente si el feed est√° disponible (publicado)
      const url = `https://spreadsheets.google.com/feeds/worksheets/${SHEET_ID}/public/full?alt=json`;
      try{
        const r = await fetch(url, {cache:"no-store"});
        if(!r.ok) throw new Error("feed not ok");
        const j = await r.json();
        const entries = j?.feed?.entry || [];
        const names = entries.map(e => e?.title?.["$t"]).filter(Boolean);
        const cleaned = names.map(n => String(n).trim()).filter(n=>n && n !== "Hoja1");
        if(cleaned.length) return cleaned;
      }catch(e){}
      return DEFAULT_SHEETS.slice();
    }

    async function fetchGviz(sheetName){
      const tq = encodeURIComponent("select *");
      const sh = encodeURIComponent(sheetName);
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${sh}&tq=${tq}`;
      const r = await fetch(url, {cache:"no-store"});
      if(!r.ok) throw new Error("No se pudo leer la hoja: " + sheetName);
      const txt = await r.text();

      // GVIZ devuelve algo como: google.visualization.Query.setResponse({...});
      const start = txt.indexOf("{");
      const end = txt.lastIndexOf("}");
      if(start < 0 || end < 0) throw new Error("Respuesta inv√°lida (GVIZ)");
      const json = JSON.parse(txt.slice(start, end+1));
      return json;
    }

    function gvizToRows(gviz){
      const table = gviz?.table;
      const cols = (table?.cols||[]).map(c=>c?.label || c?.id || "");
      const headers = cols.map(normalizeHeader);
      const rows = (table?.rows||[]).map(r=>{
        const cells = r?.c || [];
        const obj = {};
        for(let i=0;i<headers.length;i++){
          const key = headers[i] || ("col_"+i);
          obj[key] = cells[i]?.v ?? "";
        }
        return obj;
      });
      return {headers, rows};
    }

    /**********************************************************************
     * ‚úÖ CART
     **********************************************************************/
    function loadCart(){
      try{ DB.cart = JSON.parse(localStorage.getItem(CART_KEY) || "{}") || {}; }
      catch(e){ DB.cart = {}; }
      updateCartUI();
    }
    function saveCart(){
      localStorage.setItem(CART_KEY, JSON.stringify(DB.cart));
      updateCartUI();
    }
    function cartCount(){
      return Object.values(DB.cart).reduce((a,b)=>a+(+b||0),0);
    }
    function cartTotal(){
      let total = 0;
      for(const [id,qty] of Object.entries(DB.cart)){
        const p = DB.products.find(x=>x.id===id);
        if(!p) continue;
        total += (p.precioNum||0) * (qty||0);
      }
      return total;
    }
    function addToCart(id, qty=1){
      DB.cart[id] = (DB.cart[id]||0) + qty;
      if(DB.cart[id] <= 0) delete DB.cart[id];
      saveCart();
      toast("üõí Agregado al carrito");
    }
    function setQty(id, qty){
      if(qty<=0) delete DB.cart[id];
      else DB.cart[id]=qty;
      saveCart();
    }
    function money(n){
      // Ajusta moneda si quieres. Por ahora: L.
      const v = Math.round((+n||0)*100)/100;
      return "L. " + v.toLocaleString("es-HN",{minimumFractionDigits:0, maximumFractionDigits:2});
    }

    function updateCartUI(){
      const badge = $("cartBadge");
      const n = cartCount();
      if(badge){
        badge.style.display = n ? "flex" : "none";
        badge.textContent = n ? String(n) : "0";
      }
      const sum = $("cartSummary");
      const sub = $("cartSub");
      const send = $("sendOrder");
      if(sum) sum.textContent = n ? (`${n} producto(s) en carrito`) : "Carrito vac√≠o";
      if(sub) sub.textContent = n ? (`Total: ${money(cartTotal())}`) : "Agrega productos para enviar tu pedido";
      if(send) send.disabled = !n;
    }

    /**********************************************************************
     * ‚úÖ SHIPPING (opcional: hoja "_envios")
     **********************************************************************/
    async function loadShippingOptions(){
      // Si existe una hoja llamada "_envios" con columnas: nombre, precio, descripcion
      try{
        const gviz = await fetchGviz("_envios");
        const {rows} = gvizToRows(gviz);
        const opts = rows.map(r=>({
          nombre: safeStr(r.nombre || r.opcion || r.empresa),
          precio: toNumber(r.precio),
          descripcion: safeStr(r.descripcion || r.detalle || "")
        })).filter(x=>x.nombre);
        if(opts.length){
          DB.shipping = opts;
          return;
        }
      }catch(e){}
      // fallback b√°sico
      DB.shipping = [
        {nombre:"C807", precio:0, descripcion:""},
        {nombre:"Cargo Expreso", precio:0, descripcion:""},
        {nombre:"Forza", precio:0, descripcion:""},
        {nombre:"No elegir (el cliente decide)", precio:0, descripcion:""},
      ];
    }

    /**********************************************************************
     * ‚úÖ RENDER
     **********************************************************************/
    function renderTabs(){
      const tabs = $("tabs");
      if(!tabs) return;

      const cats = ["Todas", ...DB.sheets.map(s=>String(s))];
      tabs.innerHTML = "";

      for(const c of cats){
        const b = document.createElement("button");
        b.className = "tab" + (DB.activeCategory===c ? " active" : "");
        b.textContent = c.toUpperCase();
        b.onclick = ()=>{
          DB.activeCategory = c;
          saveState();
          renderTabs();
          render();
        };

        // ‚úÖ Doble toque para copiar link de categor√≠a
        let lastTap = 0;
        b.addEventListener("touchend", ()=>{
          const now = Date.now();
          if(now - lastTap < 360){
            copyCategoryLink(c);
          }
          lastTap = now;
        });

        // Desktop: doble click
        b.ondblclick = ()=>copyCategoryLink(c);

        tabs.appendChild(b);
      }
    }

    function copyCategoryLink(cat){
      const url = new URL(location.href);
      if(cat && cat !== "Todas") url.searchParams.set("cat", cat);
      else url.searchParams.delete("cat");
      navigator.clipboard?.writeText(url.toString()).then(()=>{
        toast("üîó Link copiado");
      }).catch(()=>toast("No se pudo copiar"));
    }

    function matchQuery(p, q){
      if(!q) return true;
      q = q.toLowerCase();
      const t = (p.nombre+" "+p.descripcion+" "+p.subcategoria+" "+p.categoria).toLowerCase();
      return t.includes(q);
    }

    function render(){
      const grid = $("grid");
      const countPill = $("countPill");
      const statusPill = $("statusPill");
      if(!grid) return;

      const q = (DB.query||"").trim().toLowerCase();
      let items = DB.products.slice();

      // Filter by category
      if(DB.activeCategory !== "Todas"){
        items = items.filter(p => String(p.categoria).toLowerCase() === String(DB.activeCategory).toLowerCase());
      }

      // Search filter
      items = items.filter(p=>matchQuery(p, q));

      // Sort: disponibles primero
      items.sort((a,b)=>{
        const ad = (a.stockNum>0) ? 0 : 1;
        const bd = (b.stockNum>0) ? 0 : 1;
        if(ad!==bd) return ad-bd;
        return (a.nombre||"").localeCompare(b.nombre||"", "es");
      });

      if(countPill) countPill.textContent = `${items.length} producto(s)`;
      if(statusPill) statusPill.textContent = `Actualizado ‚úÖ`;

      if(!DB.products.length){
        setCenterMsg("No hay productos para mostrar.");
      }else if(!items.length){
        setCenterMsg("Sin resultados. Prueba otra b√∫squeda.");
      }else{
        setCenterMsg("");
      }

      grid.innerHTML = "";
      for(const p of items){
        const el = document.createElement("div");
        el.className = "card";

        const img = document.createElement("div");
        img.className = "imgWrap";
        img.innerHTML = `<img src="${p.imagen || ""}" alt="${escapeHtml(p.nombre)}" onerror="this.style.opacity=.15;this.style.filter='grayscale(1)';" />`;
        if(p.stockNum <= 0){
          const mark = document.createElement("div");
          mark.className = "soldMark";
          mark.textContent = "AGOTADO";
          img.appendChild(mark);
        }

        const content = document.createElement("div");
        content.className = "content";

        const h = document.createElement("p");
        h.className = "title";
        h.textContent = p.nombre || "Producto";

        const sub = document.createElement("div");
        sub.className = "sub";
        sub.textContent = p.subcategoria ? p.subcategoria : (p.categoria || "");

        const pr = document.createElement("div");
        pr.className = "priceRow";

        const price = document.createElement("div");
        price.className = "price";
        price.textContent = money(p.precioNum);

        pr.appendChild(price);

        if(p.precioAnteriorNum > p.precioNum && p.precioAnteriorNum > 0){
          const old = document.createElement("div");
          old.className = "old";
          old.textContent = money(p.precioAnteriorNum);
          pr.appendChild(old);
        }

        const stockRow = document.createElement("div");
        stockRow.className = "stockRow";

        const st = document.createElement("div");
        st.className = "stock";
        st.textContent = p.stockNum > 0 ? `Stock: ${p.stockNum}` : "No disponible";

        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = p.stockNum > 0 ? "Agregar" : "Agotado";
        btn.disabled = p.stockNum <= 0;
        btn.onclick = ()=>addToCart(p.id, 1);

        stockRow.appendChild(st);
        stockRow.appendChild(btn);

        content.appendChild(h);
        content.appendChild(sub);
        content.appendChild(pr);
        content.appendChild(stockRow);

        el.appendChild(img);
        el.appendChild(content);
        grid.appendChild(el);
      }
    }

    function escapeHtml(s){
      return String(s||"")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    /**********************************************************************
     * ‚úÖ SEARCH OVERLAY (FIX ROBUSTO)
     **********************************************************************/
    const overlay = $("overlay");
    const searchToggle = $("searchToggle");
    const searchClose = $("searchClose");
    const searchClear = $("searchClear");

    function openSearch(){
      if(!overlay) return;
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
      setTimeout(()=> $("searchInput")?.focus(), 20);
    }
    function closeSearch(){
      if(!overlay) return;
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
    }

    if(searchToggle) searchToggle.onclick = openSearch;
    if(searchClose)  searchClose.onclick = closeSearch;

    if(overlay){
      overlay.addEventListener("click",(e)=>{ if(e.target===overlay) closeSearch(); });
    }

    if(searchClear){
      searchClear.onclick = ()=>{
        const si=document.getElementById("searchInput");
        if(si){ si.value=""; si.focus(); }
        DB.query = "";
        saveState();
        render();
      };
    }

    // Enter/Espacio para el icono lupa (porque es div)
    if(searchToggle){
      searchToggle.addEventListener("keydown",(e)=>{
        if(e.key==="Enter" || e.key===" "){ e.preventDefault(); searchToggle.click(); }
      });
    }

    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape" && overlay && overlay.classList.contains("show")) closeSearch();
    });

    const siEl = document.getElementById("searchInput");
    if(siEl){
      siEl.addEventListener("input", ()=>{
        DB.query = siEl.value || "";
        saveState();
        render();
      });
      siEl.addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); closeSearch(); }
      });
    }

    /**********************************************************************
     * ‚úÖ CART MODAL
     **********************************************************************/
    const cartOverlay = $("cartOverlay");
    const cartBtn = $("cartBtn");
    const cartClose = $("cartClose");
    const openCart = $("openCart");

    function openCartModal(){
      if(!cartOverlay) return;
      cartOverlay.classList.add("show");
      cartOverlay.setAttribute("aria-hidden","false");
      renderCartModal();
    }
    function closeCartModal(){
      if(!cartOverlay) return;
      cartOverlay.classList.remove("show");
      cartOverlay.setAttribute("aria-hidden","true");
    }

    if(cartBtn) cartBtn.onclick = openCartModal;
    if(openCart) openCart.onclick = openCartModal;
    if(cartClose) cartClose.onclick = closeCartModal;

    if(cartOverlay){
      cartOverlay.addEventListener("click",(e)=>{ if(e.target===cartOverlay) closeCartModal(); });
    }

    function renderCartModal(){
      const body = $("cartBody");
      if(!body) return;

      const ids = Object.keys(DB.cart);
      if(!ids.length){
        body.innerHTML = `<div class="centerMsg">Tu carrito est√° vac√≠o.</div>`;
        return;
      }

      let html = "";
      html += `<div style="display:flex;flex-direction:column;gap:10px">`;

      for(const id of ids){
        const p = DB.products.find(x=>x.id===id);
        if(!p) continue;
        const qty = DB.cart[id] || 0;

        html += `
          <div style="display:flex;gap:10px;align-items:center;border:1px solid var(--line);border-radius:14px;padding:10px;background:var(--bg)">
            <div style="width:56px;height:56px;border-radius:12px;overflow:hidden;border:1px solid var(--line);flex:0 0 auto;background:var(--card)">
              <img src="${p.imagen||""}" style="width:100%;height:100%;object-fit:cover;display:block" onerror="this.style.opacity=.2;this.style.filter='grayscale(1)';" />
            </div>
            <div style="min-width:0;flex:1">
              <div style="font-weight:1000;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(p.nombre)}</div>
              <div style="color:var(--muted);font-weight:900;font-size:12px">${money(p.precioNum)} c/u</div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex:0 0 auto">
              <button class="ghost" onclick="window.__dec('${id}')">-</button>
              <div style="min-width:26px;text-align:center;font-weight:1000">${qty}</div>
              <button class="ghost" onclick="window.__inc('${id}')">+</button>
            </div>
          </div>
        `;
      }

      html += `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:2px">
          <div style="color:var(--muted);font-weight:1000">Total</div>
          <div style="font-weight:1000">${money(cartTotal())}</div>
        </div>

        <div style="margin-top:8px;border-top:1px solid var(--line);padding-top:10px">
          <div style="font-weight:1000;margin-bottom:6px">Env√≠o (opcional)</div>
          <select id="shipSelect" class="input" style="font-weight:1000">
            ${DB.shipping.map((s,i)=>`<option value="${i}">${escapeHtml(s.nombre)}${s.precio?` (+${money(s.precio)})`:""}</option>`).join("")}
          </select>

          <div style="font-weight:1000;margin:10px 0 6px">Pago</div>
          <select id="paySelect" class="input" style="font-weight:1000">
            <option value="PAGAR AL RECIBIR">PAGAR AL RECIBIR</option>
            <option value="TRANSFERENCIA">TRANSFERENCIA</option>
          </select>

          <div style="font-weight:1000;margin:10px 0 6px">Notas</div>
          <textarea id="notes" class="input" style="min-height:86px;resize:vertical;font-weight:900" placeholder="Ej: Direcci√≥n, referencias, municipio, etc."></textarea>

          <button class="btn" style="width:100%;margin-top:10px" onclick="window.__send()">ENVIAR POR WHATSAPP</button>
        </div>
      `;
      html += `</div>`;

      body.innerHTML = html;
    }

    window.__inc = (id)=> setQty(id, (DB.cart[id]||0) + 1);
    window.__dec = (id)=> setQty(id, (DB.cart[id]||0) - 1);

    function buildWhatsAppMessage(){
      const ids = Object.keys(DB.cart);
      let msg = "Hola, quiero hacer este pedido:%0A%0A";
      for(const id of ids){
        const p = DB.products.find(x=>x.id===id);
        if(!p) continue;
        const qty = DB.cart[id] || 0;
        msg += `‚Ä¢ ${encodeURIComponent(p.nombre)} x${qty} = ${encodeURIComponent(money((p.precioNum||0)*qty))}%0A`;
      }
      msg += `%0A*Total:* ${encodeURIComponent(money(cartTotal()))}%0A`;

      // Shipping + payment + notes (si est√° abierto modal)
      const shipSel = document.getElementById("shipSelect");
      const paySel  = document.getElementById("paySelect");
      const notes   = document.getElementById("notes");

      let shipTxt = "";
      if(shipSel && DB.shipping[+shipSel.value]){
        const s = DB.shipping[+shipSel.value];
        shipTxt = s?.nombre ? s.nombre : "";
      }
      const payTxt = paySel ? paySel.value : "PAGAR AL RECIBIR";
      const notesTxt = notes ? notes.value.trim() : "";

      msg += `%0A*Env√≠o:* ${encodeURIComponent(shipTxt || "No elegido")}%0A`;
      msg += `*Pago:* ${encodeURIComponent(payTxt)}%0A`;
      if(notesTxt) msg += `*Notas:* ${encodeURIComponent(notesTxt)}%0A`;

      return msg;
    }

    window.__send = ()=>{
      const wa = "50432429490";
      const msg = buildWhatsAppMessage();
      window.open(`https://wa.me/${wa}?text=${msg}`, "_blank", "noopener,noreferrer");
    };

    // Bot√≥n fijo inferior
    $("sendOrder").addEventListener("click", ()=>{
      openCartModal();
      setTimeout(()=>document.getElementById("notes")?.focus(), 50);
    });

    /**********************************************************************
     * ‚úÖ THEME INIT + TOGGLE (FIX)
     **********************************************************************/
    (function initTheme(){
      const st = loadState();
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      const startDark = (st && typeof st.dark !== "undefined") ? !!st.dark : prefersDark;

      applyTheme(startDark);

      const themeBtn = document.getElementById("themeToggle");
      if(themeBtn){
        themeBtn.addEventListener("click", ()=>{
          applyTheme(!dark);
          saveState();
          toast(dark ? "üåô Modo noche" : "‚òÄÔ∏è Modo d√≠a");
        });

        // Accesibilidad: Enter/Espacio en el bot√≥n (porque es div)
        themeBtn.addEventListener("keydown", (e)=>{
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            themeBtn.click();
          }
        });
      }
    })();

    /**********************************************************************
     * ‚úÖ LOAD ALL DATA
     **********************************************************************/
    async function loadAll(){
      $("statusPill").textContent = "Cargando hojas‚Ä¶";
      DB.sheets = await fetchSheetNames();

      // URL params (cat)
      const url = new URL(location.href);
      const st = loadState();
      const catParam = url.searchParams.get("cat");
      DB.activeCategory = catParam || st.cat || "Todas";
      DB.query = st.q || "";

      // precarga query en search input
      const si = $("searchInput");
      if(si) si.value = DB.query || "";

      renderTabs();

      $("statusPill").textContent = "Leyendo productos‚Ä¶";

      const all = [];
      for(const sh of DB.sheets){
        try{
          const gviz = await fetchGviz(sh);
          const {rows} = gvizToRows(gviz);

          // Map a tu formato: categoria,nombre,precio,precio_anterior,stock,imagen,galeria,estado,subcategoria,descripcion,whatsapp
          for(const r of rows){
            const categoria = safeStr(r.categoria || sh);
            const nombre = safeStr(r.nombre || r.producto || r.titulo);
            if(!nombre) continue;

            const precioNum = toNumber(r.precio);
            const precioAnteriorNum = toNumber(r.precio_anterior || r.precioanterior || r.precio_prev || r.precio_anterior_);
            const stockNum = Math.max(0, Math.floor(toNumber(r.stock)));

            const p = {
              categoria,
              nombre,
              precioNum,
              precioAnteriorNum,
              stockNum,
              imagen: safeStr(r.imagen || r.foto || r.url || ""),
              galeria: safeStr(r.galeria || ""),
              estado: safeStr(r.estado || ""),
              subcategoria: safeStr(r.subcategoria || ""),
              descripcion: safeStr(r.descripcion || ""),
              whatsapp: safeStr(r.whatsapp || ""),
            };

            p.id = makeId({categoria, nombre, precio: precioNum});
            all.push(p);
          }
        }catch(e){
          console.warn("Error leyendo hoja:", sh, e);
        }
      }

      DB.products = all;

      // Si vino una categor√≠a inv√°lida, vuelve a Todas
      const catsLower = new Set(["todas", ...DB.sheets.map(s=>String(s).toLowerCase())]);
      if(!catsLower.has(String(DB.activeCategory).toLowerCase())){
        DB.activeCategory = "Todas";
      }

      $("statusPill").textContent = "Listo ‚úÖ";
      renderTabs();
      render();
    }

    /**********************************************************************
     * ‚úÖ INIT (asegura carga)
     **********************************************************************/
    (function boot(){
      try{
        loadCart();                 // muestra carrito si ya exist√≠a
        loadShippingOptions();      // carga _envios si existe
      }catch(e){}

      try{
        loadAll();                  // carga cat√°logo
      }catch(e){
        console.error("Boot error:", e);
        showFatal("‚ö†Ô∏è Error iniciando el cat√°logo. Actualiza la p√°gina.");
      }
    })();
  </script>
</body>
</html>
