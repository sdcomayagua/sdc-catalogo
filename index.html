<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Soluciones Digitales Comayagua | Catálogo</title>
  <meta name="description" content="Catálogo en línea de Soluciones Digitales Comayagua. Productos, stock y pedidos por WhatsApp." />
  <meta name="theme-color" content="#0b5fff" />
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --brand:#0b5fff;
      --brand2:#18a34a;
      --danger:#dc2626;
      --warn:#f59e0b;
      --shadow:0 10px 28px rgba(15,23,42,.10);
      --radius:18px;
      --radius2:14px;
      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeTop: env(safe-area-inset-top, 0px);
    }
    body.dark{
      --bg:#0b1220;
      --card:#0f1b2e;
      --text:#e6edf7;
      --muted:#9aa7be;
      --line:#1d2b45;
      --shadow:0 14px 40px rgba(0,0,0,.40);
      --brand:#4f8cff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(11,95,255,.18), transparent 55%),
                  radial-gradient(900px 700px at 110% 10%, rgba(24,163,74,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
      overflow-x:hidden;
    }
    a{color:inherit}
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: color-mix(in srgb, var(--bg) 86%, transparent);
      border-bottom:1px solid var(--line);
      padding: calc(10px + var(--safeTop)) 14px 10px;
    }
    .toprow{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      max-width:1100px; margin:0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, var(--brand), color-mix(in srgb, var(--brand) 30%, #00d4ff));
      box-shadow: 0 12px 22px rgba(11,95,255,.25);
      color:#fff; font-weight:900; letter-spacing:.5px;
      flex:0 0 auto;
    }
    .brand h1{
      font-size:15.5px; line-height:1.1; margin:0;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand .sub{
      margin-top:2px;
      font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .actions{display:flex; gap:8px; align-items:center}
    .iconbtn{
      width:42px; height:42px;
      border-radius:14px;
      border:1px solid var(--line);
      background: var(--card);
      display:grid; place-items:center;
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
      cursor:pointer;
      transition: transform .12s ease;
    }
    .iconbtn:active{transform: scale(.98)}
    .badge{
      position:relative;
    }
    .badge::after{
      content: attr(data-badge);
      position:absolute;
      top:-6px; right:-6px;
      min-width:18px; height:18px;
      padding:0 5px;
      border-radius:999px;
      background: var(--danger);
      color:#fff; font-size:11px; font-weight:800;
      display:grid; place-items:center;
      border:2px solid var(--bg);
    }
    .badge[data-badge="0"]::after{display:none}
    main{
      max-width:1100px; margin:0 auto;
      padding: 14px 14px calc(120px + var(--safeBottom));
    }
    .hero{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:stretch; justify-content:space-between;
      margin: 10px 0 12px;
    }
    .pill{
      flex:1 1 160px;
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px 12px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .pill::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(400px 130px at 10% 0%, rgba(11,95,255,.20), transparent 55%),
                  radial-gradient(420px 180px at 90% 10%, rgba(24,163,74,.16), transparent 55%);
      opacity:.9; pointer-events:none;
    }
    .pill > *{position:relative}
    .pill .k{
      font-size:12px; color:var(--muted);
    }
    .pill .v{
      margin-top:4px;
      font-size:20px; font-weight:900;
      letter-spacing:.2px;
    }
    .pill .small{
      margin-top:2px; font-size:12px; color:var(--muted);
    }

    .filters{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center;
      margin: 12px 0 12px;
    }
    .search{
      flex: 1 1 260px;
      display:flex; align-items:center; gap:10px;
      padding: 12px 12px;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
    }
    .search svg{opacity:.8}
    .search input{
      border:none; outline:none; width:100%;
      font-size:14px;
      background:transparent;
      color:var(--text);
    }
    .select{
      flex:0 0 auto;
      min-width: 180px;
      padding: 12px 12px;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    .chips{
      display:flex; gap:8px; flex-wrap:wrap;
      margin: 6px 0 14px;
    }
    .chip{
      border:1px solid var(--line);
      background: var(--card);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(15,23,42,.05);
      user-select:none;
    }
    .chip.active{
      border-color: color-mix(in srgb, var(--brand) 65%, var(--line));
      background: color-mix(in srgb, var(--brand) 12%, var(--card));
    }
    .hint{
      margin: 6px 0 0;
      font-size:12px;
      color: var(--muted);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns: repeat(8,1fr);}
    }
    @media (max-width: 560px){
      .grid{grid-template-columns: repeat(4,1fr);}
      .select{min-width: 140px}
    }
    .card{
      grid-column: span 3;
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height: 100%;
      position:relative;
    }
    @media (max-width: 900px){ .card{grid-column: span 4;} }
    @media (max-width: 560px){ .card{grid-column: span 4;} }

    .thumb{
      width:100%;
      aspect-ratio: 1 / 1;
      background: linear-gradient(135deg, rgba(11,95,255,.12), rgba(24,163,74,.10));
      display:grid; place-items:center;
      position:relative;
    }
    .thumb img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .tag{
      position:absolute; top:10px; left:10px;
      padding: 6px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight:800;
      background: color-mix(in srgb, var(--brand) 14%, var(--card));
      border: 1px solid color-mix(in srgb, var(--brand) 35%, var(--line));
      color: var(--text);
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
      max-width: calc(100% - 20px);
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .soldoutMark{
      position:absolute; inset:0;
      display:none;
      pointer-events:none;
    }
    .card.soldout .soldoutMark{display:block}
    .soldoutMark::before{
      content:"AGOTADO";
      position:absolute;
      left:-25%;
      top:45%;
      width:150%;
      text-align:center;
      transform: rotate(-18deg);
      font-weight: 1000;
      font-size: 42px;
      letter-spacing: 3px;
      color: rgba(220,38,38,.80);
      text-shadow: 0 2px 10px rgba(220,38,38,.25);
    }
    .cardBody{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:1 1 auto;
    }
    .title{
      font-size: 13.5px;
      font-weight: 900;
      line-height: 1.2;
      margin:0;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height: 34px;
    }
    .meta{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-end;
    }
    .price{
      font-weight: 1000;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .old{
      font-size: 12px;
      color: var(--muted);
      text-decoration: line-through;
      margin-left:6px;
      font-weight:700;
    }
    .stock{
      font-size: 12px;
      color: var(--muted);
      text-align:right;
      font-weight:700;
    }
    .btnRow{
      display:flex;
      gap:8px;
      margin-top: 2px;
    }
    .btn{
      flex:1 1 auto;
      border:none;
      border-radius: 14px;
      padding: 10px 10px;
      font-weight: 900;
      cursor:pointer;
      background: var(--brand);
      color:#fff;
      box-shadow: 0 14px 24px rgba(11,95,255,.22);
      transition: transform .12s ease;
    }
    .btn:active{transform:scale(.99)}
    .btn.secondary{
      background: color-mix(in srgb, var(--card) 90%, var(--brand));
      color: var(--text);
      border:1px solid var(--line);
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    .section{
      margin-top: 18px;
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sectionHead{
      padding: 14px 14px 10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, color-mix(in srgb, var(--brand) 6%, var(--card)), var(--card));
    }
    .sectionHead h2{
      margin:0;
      font-size: 15px;
      letter-spacing:.2px;
    }
    .sectionHead p{
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted);
    }
    .copyLink{
      flex:0 0 auto;
      border:1px solid var(--line);
      background: var(--card);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 10px;
      font-weight:900;
      cursor:pointer;
    }
    .sectionBody{padding: 14px;}
    .cards3{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
    }
    .mini{
      grid-column: span 4;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 92%, var(--bg));
      border-radius: var(--radius2);
      padding: 12px;
    }
    @media (max-width: 820px){ .mini{grid-column: span 6;} }
    @media (max-width: 520px){ .mini{grid-column: span 12;} }
    .mini b{display:block; margin-bottom:6px}
    .mini .muted{color:var(--muted); font-size:12px}
    details{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding: 10px 12px;
      background: color-mix(in srgb, var(--card) 92%, var(--bg));
      margin-bottom:10px;
    }
    details summary{
      cursor:pointer;
      font-weight: 900;
      list-style:none;
    }
    details summary::-webkit-details-marker{display:none}
    details .muted{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.45}
    .linkBtns{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .linkBtn{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: var(--card);
      text-decoration:none;
      font-weight: 900;
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
    }
    .socialGrid{
      display:flex; flex-wrap:wrap; gap:10px;
    }
    .social{
      flex:1 1 190px;
      display:flex; align-items:center; gap:10px;
      padding: 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: var(--card);
      text-decoration:none;
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
    }
    .social .ico{
      width:40px; height:40px; border-radius:14px;
      display:grid; place-items:center;
      background: color-mix(in srgb, var(--brand) 10%, var(--bg));
      border: 1px solid var(--line);
    }
    .social b{display:block}
    .social span{display:block; font-size:12px; color:var(--muted)}

    /* Modals */
    .overlay{
      position:fixed; inset:0; z-index:100;
      background: rgba(2,6,23,.55);
      display:none;
      padding: 10px 10px calc(10px + var(--safeBottom));
    }
    .overlay.show{display:flex}
    .sheet{
      margin: auto;
      width: min(980px, 100%);
      max-height: min(92vh, 920px);
      overflow:auto;
      background: var(--card);
      border-radius: 22px;
      border:1px solid var(--line);
      box-shadow: 0 20px 80px rgba(0,0,0,.35);
    }
    .sheetHead{
      position:sticky; top:0;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding: 12px 12px;
      background: color-mix(in srgb, var(--card) 86%, transparent);
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(14px);
      z-index:2;
    }
    .sheetHead h3{margin:0; font-size:15px}
    .close{
      width:44px; height:44px; border-radius:16px;
      border:1px solid var(--line);
      background: var(--card);
      cursor:pointer;
      display:grid; place-items:center;
    }
    .sheetBody{padding: 12px}
    .prodModalGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .prodModalGrid{grid-template-columns: 1fr;}
    }
    .gallery{
      border:1px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
      background: color-mix(in srgb, var(--card) 92%, var(--bg));
    }
    .galleryMain{
      aspect-ratio: 1 / 1;
      background: linear-gradient(135deg, rgba(11,95,255,.12), rgba(24,163,74,.10));
      display:grid; place-items:center;
    }
    .galleryMain img{width:100%; height:100%; object-fit:cover}
    .thumbs{
      display:flex; gap:8px;
      padding: 10px;
      overflow:auto;
      border-top:1px solid var(--line);
    }
    .thumbs button{
      width:64px; height:64px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: transparent;
      padding:0;
      overflow:hidden;
      cursor:pointer;
      flex: 0 0 auto;
      opacity:.85;
    }
    .thumbs button.active{outline: 2px solid color-mix(in srgb, var(--brand) 75%, transparent); opacity:1}
    .thumbs img{width:100%; height:100%; object-fit:cover; display:block}
    .panel{
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 12px;
      background: color-mix(in srgb, var(--card) 92%, var(--bg));
    }
    .panel h4{margin:0 0 6px; font-size:16px}
    .panel .muted{color:var(--muted); font-size:12px; line-height:1.45}
    .panel .row{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .kpi{
      flex:1 1 120px;
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
      background: var(--card);
    }
    .kpi .k{font-size:12px; color:var(--muted)}
    .kpi .v{font-size:16px; font-weight:1000; margin-top:4px}
    .panel .actions2{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .actions2 .btn{flex:1 1 160px}

    /* Cart */
    .cartList{display:flex; flex-direction:column; gap:10px; margin-bottom:12px}
    .cartItem{
      display:grid;
      grid-template-columns: 62px 1fr auto;
      gap:10px;
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 10px;
      background: color-mix(in srgb, var(--card) 92%, var(--bg));
      align-items:center;
    }
    .cartItem img{
      width:62px; height:62px; border-radius: 16px;
      object-fit:cover;
      border:1px solid var(--line);
      background: rgba(11,95,255,.08);
    }
    .ciName{font-weight:1000; font-size:13px; margin:0 0 4px; line-height:1.15}
    .ciMeta{font-size:12px; color:var(--muted)}
    .qty{
      display:flex; align-items:center; gap:8px; justify-content:flex-end;
    }
    .qbtn{
      width:34px; height:34px; border-radius: 12px;
      border:1px solid var(--line);
      background: var(--card);
      cursor:pointer;
      font-weight:1000;
    }
    .qval{min-width:28px; text-align:center; font-weight:1000}
    .totals{
      border-top:1px solid var(--line);
      padding-top: 10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      font-size: 13px;
    }
    .totals .muted{color:var(--muted)}
    .totals .big{
      font-size: 18px;
      font-weight: 1000;
    }
    .formGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:10px;
      margin-top:12px;
    }
    .field{grid-column: span 6;}
    @media (max-width: 620px){ .field{grid-column: span 12;} }
    .field label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin: 0 0 6px;
      font-weight: 800;
    }
    .field input,.field select,.field textarea{
      width:100%;
      border-radius: 16px;
      border:1px solid var(--line);
      padding: 12px 12px;
      background: var(--card);
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{resize:vertical; min-height: 92px}
    .divider{
      margin: 12px 0;
      height:1px; background: var(--line);
    }
    .toggleRow{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tbtn{
      flex:1 1 160px;
      border-radius: 16px;
      padding: 12px 12px;
      border:1px solid var(--line);
      background: var(--card);
      cursor:pointer;
      font-weight:1000;
    }
    .tbtn.active{
      border-color: color-mix(in srgb, var(--brand) 65%, var(--line));
      background: color-mix(in srgb, var(--brand) 12%, var(--card));
    }

    /* Bottom cart bar */
    .cartbar{
      position:fixed; left:12px; right:12px;
      bottom: calc(12px + var(--safeBottom));
      z-index:60;
      display:none;
    }
    .cartbar.show{display:block}
    .cartbarInner{
      max-width:1100px; margin:0 auto;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border:1px solid var(--line);
      border-radius: 22px;
      padding: 10px 12px;
      backdrop-filter: blur(16px);
      box-shadow: 0 20px 55px rgba(0,0,0,.22);
    }
    .cartbarInner .left{
      display:flex; gap:10px; align-items:center;
      min-width:0;
    }
    .cartbarInner .sum{
      min-width:0;
    }
    .cartbarInner .sum b{display:block; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .cartbarInner .sum span{display:block; font-size:12px; color:var(--muted)}
    .cartbarInner .btn{flex:0 0 auto; padding: 12px 14px; border-radius: 18px}
    .cartMini{
      width:44px; height:44px; border-radius: 16px;
      border:1px solid var(--line);
      background: var(--card);
      display:grid; place-items:center;
      cursor:pointer;
      flex:0 0 auto;
    }

    /* WhatsApp FAB */
    .waFab{
      position:fixed;
      right: 16px;
      bottom: calc(92px + var(--safeBottom));
      width:56px; height:56px;
      border-radius: 20px;
      background: #25D366;
      box-shadow: 0 18px 45px rgba(0,0,0,.28);
      display:grid;
      place-items:center;
      z-index:70;
      text-decoration:none;
    }
    .waFab:active{transform: scale(.98)}
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(18px + var(--safeBottom));
      transform: translateX(-50%);
      z-index:200;
      background: rgba(2,6,23,.85);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 800;
      font-size: 13px;
      display:none;
      max-width: calc(100vw - 24px);
      text-align:center;
    }
    .toast.show{display:block}
    .skeleton{
      border-radius: var(--radius);
      background: linear-gradient(90deg, rgba(148,163,184,.20), rgba(148,163,184,.10), rgba(148,163,184,.20));
      background-size: 260% 100%;
      animation: shimmer 1.4s infinite linear;
    }
    @keyframes shimmer{
      0%{background-position: 0% 0%}
      100%{background-position: -120% 0%}
    }
    .empty{
      margin: 10px 0 0;
      color: var(--muted);
      font-size: 13px;
      display:none;
    }
  </style>
</head>
<body>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <header class="topbar">
    <div class="toprow">
      <div class="brand" role="banner">
        <div class="logo" aria-hidden="true">SDC</div>
        <div style="min-width:0">
          <h1>Soluciones Digitales Comayagua</h1>
          <div class="sub">Catálogo 2026 · Envíos y pedidos por WhatsApp</div>
        </div>
      </div>

      <div class="actions">
        <button class="iconbtn" id="btnTheme" title="Día / Noche" aria-label="Cambiar tema">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 14.5A7.5 7.5 0 0 1 9.5 3a6.5 6.5 0 1 0 11.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </button>

        <button class="iconbtn badge" id="btnCart" data-badge="0" title="Carrito" aria-label="Abrir carrito">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6h15l-2 9H7L6 6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M6 6 5 3H2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M9 20a1 1 0 1 0 0-2 1 1 0 0 0 0 2ZM18 20a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main id="top">
    <section class="hero" id="inicio">
      <div class="pill">
        <div class="k">Productos cargados</div>
        <div class="v" id="statProducts">—</div>
        <div class="small" id="statUpdated">Actualizado: —</div>
      </div>
      <div class="pill">
        <div class="k">Categorías</div>
        <div class="v" id="statCats">—</div>
        <div class="small">Tip: toca 2 veces una categoría para copiar el enlace</div>
      </div>
      <div class="pill">
        <div class="k">Atención</div>
        <div class="v">WhatsApp</div>
        <div class="small">Pedidos al <b id="statWA">—</b></div>
      </div>
    </section>

    <section class="filters" aria-label="Buscar y filtrar">
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M11 18a7 7 0 1 1 0-14 7 7 0 0 1 0 14Z" stroke="currentColor" stroke-width="2"/>
        </svg>
        <input id="q" type="search" placeholder="Buscar producto, nombre o descripción" autocomplete="off" />
      </div>

      <select class="select" id="catSelect" aria-label="Filtrar por categoría"></select>
      <select class="select" id="sortSelect" aria-label="Ordenar">
        <option value="relev">Orden: Relevancia</option>
        <option value="name_asc">Nombre A → Z</option>
        <option value="name_desc">Nombre Z → A</option>
        <option value="price_asc">Precio menor → mayor</option>
        <option value="price_desc">Precio mayor → menor</option>
        <option value="stock_desc">Stock: mayor → menor</option>
      </select>

      <div class="hint" id="routeHint"></div>
    </section>

    <section class="chips" id="catChips" aria-label="Categorías rápidas"></section>

    <div id="grid" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty">No se encontraron resultados con esos filtros.</div>

    <!-- TESTIMONIOS -->
    <section class="section" id="testimonios">
      <div class="sectionHead">
        <div>
          <h2>Testimonios</h2>
          <p>Opiniones de clientes (desde Google Sheets).</p>
        </div>
        <button class="copyLink" data-copy="testimonios">Copiar enlace</button>
      </div>
      <div class="sectionBody">
        <div class="cards3" id="testiGrid">
          <div class="mini skeleton" style="height:92px"></div>
          <div class="mini skeleton" style="height:92px"></div>
          <div class="mini skeleton" style="height:92px"></div>
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section class="section" id="faq">
      <div class="sectionHead">
        <div>
          <h2>Preguntas frecuentes</h2>
          <p>Envíos, pagos, y cómo comprar.</p>
        </div>
        <button class="copyLink" data-copy="faq">Copiar enlace</button>
      </div>
      <div class="sectionBody" id="faqBody">
        <details open>
          <summary>¿Cómo hago un pedido?</summary>
          <div class="muted">
            Agrega productos al carrito, completa tus datos, elige si vives en Comayagua o fuera, y toca <b>Enviar pedido</b>.
            Se abrirá WhatsApp con el detalle completo.
          </div>
        </details>
        <details>
          <summary>¿Cómo funcionan los envíos?</summary>
          <div class="muted">
            <b>Comayagua:</b> eliges zona (Céntricas / Alejadas / Fuera de la zona) y forma de pago (Transferencia, Tigo Money o PayPal).<br/>
            <b>Fuera de Comayagua:</b> eliges departamento, municipio, empresa de envío y modalidad (Prepago o Pagar al recibir).
            Las tarifas se leen desde la hoja <b>ENVIOS</b>.
          </div>
        </details>
        <details>
          <summary>¿Puedo usar cupones?</summary>
          <div class="muted">
            Sí. En el carrito puedes ingresar un cupón. Los cupones se leen desde la hoja <b>CUPONES</b>.
          </div>
        </details>
      </div>
    </section>

    <!-- UBICACION -->
    <section class="section" id="ubicacion">
      <div class="sectionHead">
        <div>
          <h2>Ubicación</h2>
          <p>Elige tu app preferida para navegar.</p>
        </div>
        <button class="copyLink" data-copy="ubicacion">Copiar enlace</button>
      </div>
      <div class="sectionBody">
        <div class="mini">
          <b>Dirección</b>
          <div class="muted">Abre la ubicación desde Google Maps, Waze o Apple Maps.</div>
          <div class="linkBtns">
            <a class="linkBtn" id="btnMaps" target="_blank" rel="noopener">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 21s7-5.1 7-11a7 7 0 1 0-14 0c0 5.9 7 11 7 11Z" stroke="currentColor" stroke-width="2"/><path d="M12 10.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" stroke="currentColor" stroke-width="2"/></svg>
              Google Maps
            </a>
            <a class="linkBtn" id="btnWaze" target="_blank" rel="noopener">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 21s7-5 7-11a7 7 0 1 0-14 0c0 6 7 11 7 11Z" stroke="currentColor" stroke-width="2"/>
              <path d="M10.5 10.5 12 12l3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
              Waze
            </a>
            <a class="linkBtn" id="btnApple" target="_blank" rel="noopener">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 7h16v13H4V7Z" stroke="currentColor" stroke-width="2"/><path d="M7 7V4h10v3" stroke="currentColor" stroke-width="2"/><path d="M8 11h8M8 15h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              Apple Maps
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- REDES -->
    <section class="section" id="redes">
      <div class="sectionHead">
        <div>
          <h2>Redes sociales</h2>
          <p>Sígueme y mira novedades.</p>
        </div>
        <button class="copyLink" data-copy="redes">Copiar enlace</button>
      </div>
      <div class="sectionBody">
        <div class="socialGrid">
          <a class="social" id="socialFans" target="_blank" rel="noopener">
            <span class="ico" aria-hidden="true">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M22 12a10 10 0 1 0-11.5 9.9v-7H8v-3h2.5V9.8c0-2.5 1.5-3.9 3.8-3.9 1.1 0 2.2.2 2.2.2v2.4h-1.2c-1.2 0-1.6.8-1.6 1.5V12H18l-.4 3h-2.6v7A10 10 0 0 0 22 12Z"/></svg>
            </span>
            <div><b>Facebook (Fans)</b><span>Publicaciones y anuncios</span></div>
          </a>

          <a class="social" id="socialMarket" target="_blank" rel="noopener">
            <span class="ico" aria-hidden="true">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.5 2 2 6.1 2 11.2c0 3 1.5 5.7 4 7.4V22l3.1-1.7c.9.3 1.9.4 2.9.4 5.5 0 10-4.1 10-9.5S17.5 2 12 2Zm1.1 12.8h-2.3v-4H9V9.2h1.8V8c0-1.6 1-2.6 2.6-2.6h1.9v1.6h-1.2c-.6 0-1 .3-1 .9v1.3H15l-.3 1.6h-1.6v4Z"/></svg>
            </span>
            <div><b>Facebook Marketplace</b><span>Perfil de ventas</span></div>
          </a>

          <a class="social" id="socialIG" target="_blank" rel="noopener">
            <span class="ico" aria-hidden="true">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="5" stroke="currentColor" stroke-width="2"/><path d="M12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke="currentColor" stroke-width="2"/><path d="M17.5 6.5h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>
            </span>
            <div><b>Instagram</b><span>Fotos, reels y catálogo</span></div>
          </a>

          <a class="social" id="socialTT" target="_blank" rel="noopener">
            <span class="ico" aria-hidden="true">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M14 3v11.5a3.5 3.5 0 1 1-3-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M14 6c1.2 2.5 3.4 4 6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </span>
            <div><b>TikTok</b><span>Videos cortos</span></div>
          </a>
        </div>
      </div>
    </section>

    <!-- PRIVACIDAD -->
    <section class="section" id="privacidad">
      <div class="sectionHead">
        <div>
          <h2>Política de privacidad</h2>
          <p>Oculta en acordeón (toca para leer).</p>
        </div>
        <button class="copyLink" data-copy="privacidad">Copiar enlace</button>
      </div>
      <div class="sectionBody">
        <details>
          <summary>Leer política de privacidad</summary>
          <div class="muted" style="margin-top:10px">
            Esta web muestra un catálogo de productos y permite generar un pedido por WhatsApp. No recolectamos datos con fines publicitarios por nuestra cuenta.
            <br/><br/>
            <b>Datos que ingresas:</b> nombre, teléfono y dirección (solo para armar el mensaje del pedido). Esa información se envía a través de WhatsApp al negocio.
            <br/><br/>
            <b>Imágenes y contenido:</b> se cargan desde Google Sheets. Los cambios en Sheets se reflejan en la web.
            <br/><br/>
            <b>Cookies:</b> podemos usar almacenamiento local (localStorage) para recordar el tema (día/noche) y el contenido del carrito.
          </div>
        </details>
      </div>
    </section>
  </main>

  <!-- PRODUCT MODAL -->
  <div id="productOverlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet" tabindex="-1">
      <div class="sheetHead">
        <h3 id="pmTitle">Detalle del producto</h3>
        <button class="close" id="pmClose" aria-label="Cerrar">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="sheetBody">
        <div class="prodModalGrid">
          <div class="gallery">
            <div class="galleryMain" id="pmMain"></div>
            <div class="thumbs" id="pmThumbs"></div>
          </div>

          <div class="panel">
            <h4 id="pmName">—</h4>
            <div class="muted" id="pmDesc">—</div>

            <div class="row" style="margin-top:12px">
              <div class="kpi"><div class="k">Precio</div><div class="v" id="pmPrice">—</div></div>
              <div class="kpi"><div class="k">Stock</div><div class="v" id="pmStock">—</div></div>
              <div class="kpi"><div class="k">Categoría</div><div class="v" id="pmCat">—</div></div>
            </div>

            <div class="actions2">
              <button class="btn" id="pmAdd">Agregar al carrito</button>
              <button class="btn secondary" id="pmCopy">Copiar enlace</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CART MODAL -->
  <div id="cartOverlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet" tabindex="-1">
      <div class="sheetHead">
        <h3>Carrito y pedido</h3>
        <button class="close" id="cartClose" aria-label="Cerrar">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="sheetBody">
        <div id="cartEmptyMsg" class="muted" style="display:none; margin-bottom:10px">
          Tu carrito está vacío. Puedes escribirnos por WhatsApp para consultar disponibilidad.
        </div>

        <div id="cartList" class="cartList"></div>

        <div class="field" style="grid-column: span 12;">
          <label for="coupon">Cupón</label>
          <div style="display:flex; gap:10px; align-items:center">
            <input id="coupon" placeholder="Escribe tu cupón" style="flex:1 1 auto" />
            <button class="btn secondary" id="btnApplyCoupon" style="flex:0 0 auto; padding:12px 14px">Aplicar</button>
          </div>
          <div class="hint" id="couponHint"></div>
        </div>

        <div class="totals" style="margin-top:10px">
          <div class="muted">Subtotal</div><div id="tSubtotal">Lps. 0</div>
          <div class="muted">Descuento</div><div id="tDiscount">Lps. 0</div>
          <div class="muted">Envío</div><div id="tShip">Por confirmar</div>
          <div class="muted big">Total</div><div class="big" id="tTotal">Lps. 0</div>
        </div>

        <div class="divider"></div>

        <div class="formGrid">
          <div class="field">
            <label for="custName">Nombre</label>
            <input id="custName" placeholder="Tu nombre" autocomplete="name" />
          </div>
          <div class="field">
            <label for="custPhone">Teléfono</label>
            <input id="custPhone" placeholder="Ej: 9999-9999" autocomplete="tel" />
          </div>

          <div class="field" style="grid-column: span 12;">
            <label>¿Vives en Comayagua?</label>
            <div class="toggleRow" role="group" aria-label="Vives en Comayagua">
              <button class="tbtn" id="btnViveSi" type="button">Sí, Comayagua</button>
              <button class="tbtn" id="btnViveNo" type="button">No, fuera de Comayagua</button>
            </div>
            <div class="hint" id="viveHint">Selecciona una opción para ver las opciones de envío.</div>
          </div>

          <!-- COMAYAGUA -->
          <div id="comayaguaBlock" style="display:none; grid-column: span 12;">
            <div class="formGrid" style="margin-top:0">
              <div class="field">
                <label for="zonaComa">Zona (Comayagua)</label>
                <select id="zonaComa">
                  <option value="">Selecciona zona</option>
                  <option value="CENTRICAS">Céntricas</option>
                  <option value="ALEJADAS">Alejadas</option>
                  <option value="FUERA DE LA ZONA">Fuera de la zona</option>
                </select>
              </div>
              <div class="field">
                <label for="coloniaComa">Colonia / Barrio (Comayagua)</label>
                <input id="coloniaComa" placeholder="Ej: Centro, barrio..." list="dlColonias"/>
                <datalist id="dlColonias"></datalist>
              </div>

              <div class="field">
                <label for="pagoComa">Pago (Comayagua)</label>
                <select id="pagoComa">
                  <option value="">Selecciona</option>
                  <option value="TRANSFERENCIA BANCARIA">Transferencia bancaria</option>
                  <option value="TIGO MONEY">Tigo Money</option>
                  <option value="PAYPAL">PayPal</option>
                </select>
              </div>
              <div class="field">
                <label>Info</label>
                <div class="muted" id="pagoInfo" style="padding:12px; border:1px solid var(--line); border-radius:16px; background: var(--card); min-height: 46px">
                  —
                </div>
              </div>

              <div class="field" style="grid-column: span 12;">
                <label for="dirComa">Dirección y referencia</label>
                <textarea id="dirComa" placeholder="Ej: calle, punto de referencia, color de casa..."></textarea>
              </div>
            </div>
          </div>

          <!-- FUERA -->
          <div id="fueraBlock" style="display:none; grid-column: span 12;">
            <div class="formGrid" style="margin-top:0">
              <div class="field">
                <label for="dep">Departamento</label>
                <select id="dep"></select>
              </div>
              <div class="field">
                <label for="mun">Municipio</label>
                <select id="mun"></select>
              </div>

              <div class="field">
                <label for="empresa">Empresa de envío</label>
                <select id="empresa">
                  <option value="">Selecciona</option>
                  <option value="C807">C807</option>
                  <option value="Cargo Expreso">Cargo Expreso</option>
                  <option value="Forza">Forza</option>
                </select>
              </div>

              <div class="field">
                <label for="modalidad">Modalidad</label>
                <select id="modalidad">
                  <option value="">Selecciona</option>
                  <option value="PREPAGO">Prepago</option>
                  <option value="PAGAR AL RECIBIR">Pagar al recibir</option>
                </select>
              </div>

              <div class="field" style="grid-column: span 12;">
                <label for="dirFuera">Dirección y referencia</label>
                <textarea id="dirFuera" placeholder="Dirección completa y referencia (incluye barrio/colonia y puntos)."></textarea>
              </div>

              <div class="field" style="grid-column: span 12;">
                <label>Nota</label>
                <div class="muted" style="padding:12px; border:1px solid var(--line); border-radius:16px; background: var(--card)">
                  Las tarifas y cupones se administran manualmente en Google Sheets (hojas <b>ENVIOS</b> y <b>CUPONES</b>).
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px">
          <button class="btn secondary" id="btnCopyOrderLink" style="flex:1 1 180px">Copiar enlace del carrito</button>
          <button class="btn" id="btnSend" style="flex:1 1 220px">Enviar pedido por WhatsApp</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom bar -->
  <div id="cartBar" class="cartbar" aria-hidden="true">
    <div class="cartbarInner">
      <div class="left">
        <button class="cartMini" id="cartBarOpen" aria-label="Abrir carrito">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6h15l-2 9H7L6 6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M6 6 5 3H2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M9 20a1 1 0 1 0 0-2 1 1 0 0 0 0 2ZM18 20a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" stroke="currentColor" stroke-width="2"/></svg>
        </button>
        <div class="sum">
          <b id="cartBarTitle">Carrito</b>
          <span id="cartBarSub">0 ítems</span>
        </div>
      </div>
      <button class="btn" id="cartBarSend">Enviar pedido</button>
    </div>
  </div>

  <!-- WhatsApp floating button -->
  <a class="waFab" id="waFab" href="#" aria-label="WhatsApp">
    <svg width="28" height="28" viewBox="0 0 32 32" fill="none" aria-hidden="true">
      <path d="M26.7 5.3A14.8 14.8 0 0 0 16 1.2C8.2 1.2 1.8 7.5 1.8 15.4c0 2.5.6 4.8 1.8 6.9L1 31l9-2.4a14.6 14.6 0 0 0 6 1.3c7.8 0 14.2-6.3 14.2-14.1 0-3.8-1.5-7.4-3.5-10.5Z" fill="#25D366"/>
      <path d="M16 28.3c-2 0-4-.5-5.7-1.5l-.4-.2-5.3 1.4 1.4-5.1-.3-.5A12.3 12.3 0 0 1 3.7 15.4C3.7 8.7 9.2 3.3 16 3.3c3.3 0 6.4 1.3 8.7 3.6 2.3 2.3 3.6 5.4 3.6 8.7 0 6.7-5.5 12.7-12.3 12.7Z" fill="#fff"/>
      <path d="M23 19.3c-.3-.2-1.8-.9-2-1s-.5-.2-.7.2-.8 1-1 1.2-.4.2-.7 0c-.3-.2-1.2-.5-2.3-1.4-.9-.8-1.5-1.8-1.7-2.1-.2-.3 0-.5.1-.6l.5-.6c.2-.2.2-.4.3-.6 0-.2 0-.4 0-.6s-.7-1.7-1-2.3c-.3-.6-.6-.5-.7-.5h-.6c-.2 0-.6.1-.9.4-.3.3-1.1 1-1.1 2.5s1.1 2.9 1.3 3.1c.2.2 2.2 3.4 5.4 4.8.8.3 1.4.5 1.9.6.8.2 1.5.2 2.1.1.6-.1 1.8-.7 2.1-1.4.3-.7.3-1.3.2-1.4 0-.2-.3-.2-.6-.4Z" fill="#25D366"/>
    </svg>
  </a>

  <script>
    /*****************
     * CONFIG
     *****************/
    const SHEET_ID = "1pp4fQRoy9hI5aqFaEGkqIpMSb2v85FP3MgBhCqrnmt4";
    const WHATSAPP_NUMBER = "50431517755"; // <-- tu número
    const MAPS_LINK = "https://maps.app.goo.gl/odeDnVuw3ZDLk7SN7";
    const SOCIAL = {
      fans: "https://www.facebook.com/share/1byZJaxvta/",
      market: "https://www.facebook.com/marketplace/profile/100060810098217/?ref=permalink&mibextid=dXMIcH",
      ig: "https://www.instagram.com/gabrielguerrerocoello?igsh=MThtaXY0YmI2ZGd6NA==",
      tt: "https://www.tiktok.com/@gamer.comayagua?_r=1&_t=ZM-935BPKUyjTI"
    };
    const RESERVED_SHEETS = new Set(["envios","cupones","testimonios","_config","config"]);

    /*****************
     * STATE
     *****************/
    const state = {
      products: [],
      productById: new Map(),
      categories: [],
      shippingRows: [],
      coupons: [],
      testimonials: [],
      cart: loadCart(),
      route: { cat: "", q: "", sort: "relev", p: "", s: "" },
      couponApplied: null,
      viveComayagua: null, // true/false/null
      shipCost: null, // number|null
      shipCostText: "Por confirmar"
    };

    /*****************
     * HELPERS
     *****************/
    const $ = (id)=>document.getElementById(id);
    const esc = (s)=>String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=>t.classList.remove("show"), 1800);
    }
    function fmtLps(n){
      const v = Number(n || 0);
      return "Lps. " + v.toLocaleString("es-HN", {maximumFractionDigits: 2});
    }
    function asNumber(x){
      if (x == null) return NaN;
      if (typeof x === "number") return x;
      const s = String(x).replace(/[,]/g,"").replace(/[^\d.\-]/g,"");
      return s ? Number(s) : NaN;
    }
    function norm(s){ return String(s ?? "").trim(); }
    function normKey(s){ return norm(s).toLowerCase(); }
    function slug(s){
      return norm(s).toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
    }
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    /*****************
     * THEME
     *****************/
    function applyTheme(mode){
      const dark = mode === "dark";
      document.body.classList.toggle("dark", dark);
      localStorage.setItem("sdc_theme", dark ? "dark" : "light");
    }
    function initTheme(){
      const saved = localStorage.getItem("sdc_theme");
      if (saved) applyTheme(saved);
      else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) applyTheme("dark");
    }

    /*****************
     * ROUTING (hash)
     * Format: #cat=...&p=...&s=...
     *****************/
    function parseHash(){
      const h = (location.hash || "").replace(/^#/,"");
      const params = new URLSearchParams(h);
      state.route.cat = params.get("cat") || "";
      state.route.p = params.get("p") || "";
      state.route.s = params.get("s") || "";
      // keep q + sort in memory only
      updateRouteHint();
    }
    function setHash(updates){
      const params = new URLSearchParams(location.hash.replace(/^#/,""));
      Object.entries(updates).forEach(([k,v])=>{
        if (!v) params.delete(k);
        else params.set(k, v);
      });
      const next = params.toString();
      location.hash = next ? "#" + next : "";
    }
    function updateRouteHint(){
      const parts=[];
      if (state.route.cat) parts.push("Categoría: " + state.route.cat);
      if (state.route.p) parts.push("Producto: " + state.route.p);
      if (state.route.s) parts.push("Sección: " + state.route.s);
      $("routeHint").textContent = parts.length ? ("Vista: " + parts.join(" · ")) : "";
    }

    /*****************
     * SHEETS (gviz)
     *****************/
    async function fetchJSON(url){
      const res = await fetch(url, {cache:"no-store"});
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }
    async function fetchGViz(sheetName){
      const u = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      const res = await fetch(u, {cache:"no-store"});
      const txt = await res.text();
      // gviz wrapper: setResponse(...)
      const m = txt.match(/google\\.visualization\\.Query\\.setResponse\\((.*)\\);?/s);
      if (!m) throw new Error("Respuesta inválida de Sheets");
      return JSON.parse(m[1]);
    }
    function gvizToObjects(g){
      const table = g.table;
      const cols = table.cols.map(c => norm(c.label || c.id || ""));
      const rows = table.rows.map(r => r.c.map(c => c ? (c.v ?? c.f ?? "") : ""));
      const out = [];
      for (const r of rows){
        const o = {};
        cols.forEach((k,i)=>o[k]=r[i]);
        // ignore empty rows
        const any = Object.values(o).some(v=>norm(v)!=="");
        if (any) out.push(o);
      }
      return out;
    }
    async function listSheetNames(){
      // Worksheets feed works for published sheets
      const feed = `https://spreadsheets.google.com/feeds/worksheets/${SHEET_ID}/public/full?alt=json`;
      try{
        const j = await fetchJSON(feed);
        const entries = j?.feed?.entry || [];
        const names = entries.map(e => e.title?.$t).filter(Boolean);
        if (names.length) return names;
      }catch(e){}
      // Fallback (si la hoja no está publicada como "pública")
      return ["OFERTAS","Gamer","PC","Movil","Streaming","Cobertores","Power","Catalogo SDC - 2026"];
    }
    async function loadSheetObjects(sheetName){
      const g = await fetchGViz(sheetName);
      return gvizToObjects(g);
    }

    /*****************
     * NORMALIZERS
     *****************/
    function normalizeProduct(row, sheetName, idx){
      // Column name variants
      const name = norm(row.nombre ?? row.Nombre ?? row.name ?? row.Producto ?? row.producto);
      const desc = norm(row.descripcion ?? row.Descripción ?? row.descripcion_detalle ?? row.detalle ?? row.Detalle ?? "");
      const img = norm(row.imagen ?? row.Imagen ?? row.foto ?? row.Foto ?? "");
      const gal = norm(row.galeria ?? row.galería ?? row.Galeria ?? row.Galería ?? "");
      const cat = norm(row.categoria ?? row.Categoria ?? sheetName);
      const sub = norm(row.subcategoria ?? row.Subcategoria ?? row.sub ?? "");
      const estado = norm(row.estado ?? row.Estado ?? "").toUpperCase();
      const stock = Number(asNumber(row.stock ?? row.Stock ?? row.STOCK));
      const price = Number(asNumber(row.precio ?? row.Precio ?? row["precio unitario"] ?? row["precio_unitario"]));
      const old = Number(asNumber(row.precio_anterior ?? row["precio anterior"] ?? row.Precio_Anterior ?? ""));
      const whatsapp = norm(row.whatsapp ?? row.WhatsApp ?? "");
      const categoriaFinal = cat || sheetName;
      const baseId = slug(categoriaFinal) + "-" + slug(name || ("item-"+idx));
      // ensure unique
      let id = baseId;
      let n = 2;
      while (state.productById.has(id)) { id = baseId + "-" + n; n++; }

      const pics = [];
      if (img) pics.push(img);
      if (gal){
        gal.split(/[,\n]/).map(s=>s.trim()).filter(Boolean).forEach(u=>pics.push(u));
      }

      const soldout = (Number.isFinite(stock) && stock <= 0) || estado === "AGOTADO";

      return {
        id,
        categoria: categoriaFinal,
        subcategoria: sub,
        nombre: name || "(Sin nombre)",
        descripcion: desc,
        imagen: img,
        galeria: pics,
        precio: Number.isFinite(price) ? price : 0,
        precio_anterior: Number.isFinite(old) ? old : 0,
        stock: Number.isFinite(stock) ? stock : 0,
        agotado: soldout,
        whatsapp
      };
    }

    function normalizeShipping(row){
      // Flexible column names
      const area = norm(row.area ?? row.zona_area ?? row.ubicacion ?? row.Área ?? row.Area ?? row.localidad ?? "");
      const dept = norm(row.departamento ?? row.Departamento ?? row.depto ?? "");
      const muni = norm(row.municipio ?? row.Municipio ?? "");
      const zona = norm(row.zona ?? row.Zona ?? row.sector ?? "");
      const empresa = norm(row.empresa ?? row.Empresa ?? "");
      const modalidad = norm(row.modalidad ?? row.Modalidad ?? "");
      const colonias = norm(row.colonias ?? row.Colonias ?? "");
      const tarifaRaw = row.tarifa ?? row.Tarifa ?? row.precio ?? row.Precio ?? row.costo ?? row.Costo ?? "";
      const tarifaNum = asNumber(tarifaRaw);
      return {
        area, dept, muni, zona, empresa, modalidad,
        colonias,
        tarifaNum: Number.isFinite(tarifaNum) ? tarifaNum : NaN,
        tarifaText: norm(tarifaRaw)
      };
    }

    function normalizeCoupon(row){
      const code = norm(row.cupon ?? row.código ?? row.codigo ?? row.code ?? row.CUPON ?? row.Cupon).toUpperCase();
      const tipo = norm(row.tipo ?? row.Tipo ?? row.type ?? "").toUpperCase(); // PORCENTAJE / FIJO
      const valor = asNumber(row.valor ?? row.Valor ?? row.descuento ?? row.Descuento ?? "");
      const min = asNumber(row.minimo ?? row.Mínimo ?? row.min ?? row.Min ?? 0);
      const activo = norm(row.activo ?? row.Activo ?? row.estado ?? "SI").toUpperCase();
      const vence = norm(row.vence ?? row.Vence ?? row.expira ?? row.Expira ?? row.fecha ?? "");
      return {
        code,
        tipo,
        valor: Number.isFinite(valor) ? valor : NaN,
        minimo: Number.isFinite(min) ? min : 0,
        activo: !["NO","0","FALSE","INACTIVO"].includes(activo),
        vence
      };
    }

    function normalizeTestimonial(row){
      const nombre = norm(row.nombre ?? row.Nombre ?? row.cliente ?? "Cliente");
      const texto = norm(row.testimonio ?? row.Testimonio ?? row.comentario ?? row.Comentario ?? row.opinion ?? row.Opinion ?? "");
      const fecha = norm(row.fecha ?? row.Fecha ?? "");
      const estrellas = asNumber(row.estrellas ?? row.Estrellas ?? row.rating ?? "");
      return {
        nombre,
        texto: texto || "Excelente atención.",
        fecha,
        estrellas: Number.isFinite(estrellas) ? estrellas : null
      };
    }

    /*****************
     * LOAD ALL DATA
     *****************/
    async function loadAll(){
      initTheme();
      // static links
      $("statWA").textContent = "+" + WHATSAPP_NUMBER;
      $("btnMaps").href = MAPS_LINK;
      $("btnWaze").href = "https://waze.com/ul?q=" + encodeURIComponent("Soluciones Digitales Comayagua") + "&navigate=yes";
      $("btnApple").href = "https://maps.apple.com/?q=" + encodeURIComponent("Soluciones Digitales Comayagua");

      $("socialFans").href = SOCIAL.fans;
      $("socialMarket").href = SOCIAL.market;
      $("socialIG").href = SOCIAL.ig;
      $("socialTT").href = SOCIAL.tt;

      // Build departamento options (static 18)
      initDepartamentos();

      parseHash();
      window.addEventListener("hashchange", () => {
        parseHash();
        applyRoute();
      });

      // UI events
      $("btnTheme").addEventListener("click", ()=>{
        const isDark = document.body.classList.contains("dark");
        applyTheme(isDark ? "light" : "dark");
      });
      $("btnCart").addEventListener("click", ()=>openCart());
      $("cartBarOpen").addEventListener("click", ()=>openCart());
      $("cartBarSend").addEventListener("click", ()=>openCart(true));
      $("btnSend").addEventListener("click", ()=>sendOrder());
      $("btnCopyOrderLink").addEventListener("click", ()=>{
        setHash({s:"carrito"});
        copyText(location.href);
        toast("Enlace del carrito copiado");
      });

      $("cartClose").addEventListener("click", closeCart);
      $("cartOverlay").addEventListener("click", (e)=>{ if(e.target === $("cartOverlay")) closeCart(); });

      $("pmClose").addEventListener("click", closeProductModal);
      $("productOverlay").addEventListener("click", (e)=>{ if(e.target === $("productOverlay")) closeProductModal(); });

      $("q").addEventListener("input", ()=>{ state.route.q = $("q").value; render(); });
      $("catSelect").addEventListener("change", ()=>{
        const val = $("catSelect").value;
        setHash({cat: val || "" , p: ""});
      });
      $("sortSelect").addEventListener("change", ()=>{ state.route.sort = $("sortSelect").value; render(); });

      document.querySelectorAll("[data-copy]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-copy");
          setHash({s:id});
          copyText(location.href);
          toast("Enlace copiado");
          scrollToSection(id);
        });
      });

      $("btnViveSi").addEventListener("click", ()=>setVive(true));
      $("btnViveNo").addEventListener("click", ()=>setVive(false));

      $("zonaComa").addEventListener("change", ()=>{ refreshShipping(); });
      $("coloniaComa").addEventListener("input", ()=>{ /* no-op */ });
      $("pagoComa").addEventListener("change", ()=>{
        const v = $("pagoComa").value;
        $("pagoInfo").textContent = v === "TIGO MONEY"
          ? "+504 9474-6828 · A nombre de: Renee Gabriel Guerrero Coello"
          : (v === "PAYPAL" ? "Te enviaremos el enlace o correo PayPal por WhatsApp." : (v ? "Te enviaremos los datos de transferencia por WhatsApp." : "—"));
        refreshShipping();
      });

      $("dep").addEventListener("change", ()=>{ populateMunicipiosFromShipping(); refreshShipping(); });
      $("mun").addEventListener("change", ()=>{ refreshShipping(); });
      $("empresa").addEventListener("change", ()=>{ refreshShipping(); });
      $("modalidad").addEventListener("change", ()=>{ refreshShipping(); });
      $("dirComa").addEventListener("input", ()=>{ /* */ });
      $("dirFuera").addEventListener("input", ()=>{ /* */ });

      $("btnApplyCoupon").addEventListener("click", applyCoupon);

      // WhatsApp FAB behavior: cart empty => chat general; cart with items => enviar pedido
      $("waFab").addEventListener("click", (e)=>{
        e.preventDefault();
        if (state.cart.length) sendOrder();
        else openWhatsAppChat("Hola, quiero información del catálogo 🙂");
      });

      // Load sheet names
      const allSheets = await listSheetNames();
      // Load products
      const productSheets = allSheets.filter(n => !RESERVED_SHEETS.has(normKey(n)));
      const special = {
        envios: allSheets.find(n => normKey(n)==="envios"),
        cupones: allSheets.find(n => normKey(n)==="cupones"),
        testimonios: allSheets.find(n => normKey(n)==="testimonios")
      };

      // Fetch data in parallel (with small staggering for safety)
      const prodPromises = productSheets.map(async (sn, i)=>{
        await sleep(i*35);
        try{
          const objs = await loadSheetObjects(sn);
          return objs.map((r, idx)=>normalizeProduct(r, sn, idx));
        }catch(e){
          console.warn("No se pudo leer hoja", sn, e);
          return [];
        }
      });

      let products = (await Promise.all(prodPromises)).flat();

      // Deduplicate by id already unique; but if same product appears across sheets, try merge by (categoria+nombre)
      const byKey = new Map();
      for (const p of products){
        const key = slug(p.categoria) + "|" + slug(p.nombre);
        if (!byKey.has(key)) byKey.set(key, p);
        else {
          const ex = byKey.get(key);
          // prefer with image/desc/stock if missing
          if (!ex.imagen && p.imagen) ex.imagen = p.imagen;
          if ((!ex.descripcion || ex.descripcion.length < 3) && p.descripcion) ex.descripcion = p.descripcion;
          if (ex.stock === 0 && p.stock > 0) ex.stock = p.stock;
          if (ex.precio === 0 && p.precio > 0) ex.precio = p.precio;
          ex.galeria = Array.from(new Set([...(ex.galeria||[]), ...(p.galeria||[])]));
        }
      }
      products = Array.from(byKey.values());

      state.products = products;
      state.productById = new Map(products.map(p=>[p.id,p]));

      // categories
      const cats = Array.from(new Set(products.map(p=>p.categoria).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"es"));
      state.categories = cats;

      // Load ENVIOS / CUPONES / TESTIMONIOS if exist
      if (special.envios){
        try{
          const rows = await loadSheetObjects(special.envios);
          state.shippingRows = rows.map(normalizeShipping).filter(r=>Object.values(r).some(v=>norm(v)!==""));
          populateMunicipiosFromShipping();
          populateColoniasFromShipping();
        }catch(e){ console.warn("envios", e); }
      }
      if (special.cupones){
        try{
          const rows = await loadSheetObjects(special.cupones);
          state.coupons = rows.map(normalizeCoupon).filter(c=>c.code);
        }catch(e){ console.warn("cupones", e); }
      }
      if (special.testimonios){
        try{
          const rows = await loadSheetObjects(special.testimonios);
          state.testimonials = rows.map(normalizeTestimonial).filter(t=>t.texto);
        }catch(e){ console.warn("testimonios", e); }
      }

      // Update stats + UI
      $("statProducts").textContent = String(products.length);
      $("statCats").textContent = String(cats.length);
      $("statUpdated").textContent = "Actualizado: " + new Date().toLocaleString("es-HN", {dateStyle:"medium", timeStyle:"short"});
      buildCategoryUI();
      renderTestimonials();
      applyRoute(); // applies cat/p/section route and renders
      updateCartUI();
    }

    /*****************
     * CATEGORY UI
     *****************/
    function buildCategoryUI(){
      const sel = $("catSelect");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Todas las categorías";
      sel.appendChild(opt0);
      for (const c of state.categories){
        const o = document.createElement("option");
        o.value = c;
        o.textContent = c;
        sel.appendChild(o);
      }

      const chips = $("catChips");
      chips.innerHTML = "";

      // Inicio chip
      chips.appendChild(makeChip("Inicio", "", true));

      for (const c of state.categories){
        chips.appendChild(makeChip(c, c));
      }
    }

    function makeChip(label, cat, isHome=false){
      const b = document.createElement("button");
      b.className = "chip";
      b.type = "button";
      b.textContent = label;
      let lastTap = 0;

      b.addEventListener("click", ()=>{
        const now = Date.now();
        // double tap to copy link
        if (now - lastTap < 420){
          setHash({cat: cat || "", p:"", s:""});
          copyText(location.href);
          toast("Enlace de " + (cat || "Inicio") + " copiado");
        }else{
          setHash({cat: cat || "", p:"", s:""});
        }
        lastTap = now;
      });

      return b;
    }

    /*****************
     * ROUTE APPLY
     *****************/
    function applyRoute(){
      // set category selection UI
      $("catSelect").value = state.route.cat || "";
      // update chips active
      Array.from(document.querySelectorAll(".chip")).forEach(ch=>{
        const txt = ch.textContent;
        const target = (txt==="Inicio") ? "" : txt;
        ch.classList.toggle("active", target === (state.route.cat || ""));
      });

      render();

      // Product modal route
      if (state.route.p){
        const p = state.productById.get(state.route.p);
        if (p) openProductModal(p, {replaceHash:false});
      }else{
        closeProductModal(false);
      }

      // Section route
      if (state.route.s){
        // slight delay to let layout settle
        setTimeout(()=>scrollToSection(state.route.s), 80);
      }
    }

    function scrollToSection(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }

    /*****************
     * RENDER CATALOG
     *****************/
    function render(){
      const grid = $("grid");
      const empty = $("empty");
      const q = (state.route.q || $("q").value || "").trim().toLowerCase();
      const cat = state.route.cat || "";
      const sort = state.route.sort || "relev";

      // filter
      let items = state.products.filter(p=>{
        if (cat && p.categoria !== cat) return false;
        if (!q) return true;
        const hay = (p.nombre + " " + p.descripcion + " " + p.subcategoria + " " + p.categoria).toLowerCase();
        return hay.includes(q);
      });

      // sort
      const byName = (a,b)=>a.nombre.localeCompare(b.nombre,"es");
      const byPrice = (a,b)=>a.precio - b.precio;
      const byStock = (a,b)=>b.stock - a.stock;
      if (sort==="name_asc") items.sort(byName);
      else if (sort==="name_desc") items.sort((a,b)=>-byName(a,b));
      else if (sort==="price_asc") items.sort(byPrice);
      else if (sort==="price_desc") items.sort((a,b)=>-byPrice(a,b));
      else if (sort==="stock_desc") items.sort(byStock);
      else {
        // relev: in-stock first, then name
        items.sort((a,b)=>{
          const ai = a.agotado ? 1 : 0;
          const bi = b.agotado ? 1 : 0;
          if (ai !== bi) return ai - bi;
          return byName(a,b);
        });
      }

      grid.innerHTML = "";
      empty.style.display = items.length ? "none" : "block";

      const frag = document.createDocumentFragment();
      for (const p of items){
        frag.appendChild(renderCard(p));
      }
      grid.appendChild(frag);
    }

    function renderCard(p){
      const card = document.createElement("article");
      card.className = "card" + (p.agotado ? " soldout" : "");
      const tag = p.subcategoria || p.categoria;

      const imgHTML = p.imagen ? `<img loading="lazy" src="${esc(p.imagen)}" alt="${esc(p.nombre)}">` : `<div class="muted">Sin imagen</div>`;

      card.innerHTML = `
        <div class="thumb">
          ${imgHTML}
          <div class="tag" title="${esc(tag)}">${esc(tag)}</div>
          <div class="soldoutMark" aria-hidden="true"></div>
        </div>
        <div class="cardBody">
          <h3 class="title">${esc(p.nombre)}</h3>
          <div class="meta">
            <div>
              <span class="price">${esc(fmtLps(p.precio))}</span>
              ${p.precio_anterior > 0 ? `<span class="old">${esc(fmtLps(p.precio_anterior))}</span>` : ``}
            </div>
            <div class="stock">${p.agotado ? "Agotado" : ("Stock: " + p.stock)}</div>
          </div>
          <div class="btnRow">
            <button class="btn" ${p.agotado ? "disabled" : ""}>Agregar</button>
            <button class="btn secondary">Detalles</button>
          </div>
        </div>
      `;

      const [btnAdd, btnDet] = card.querySelectorAll("button");
      btnAdd.addEventListener("click", ()=>addToCart(p.id, 1));
      btnDet.addEventListener("click", ()=>openProductModal(p, {replaceHash:true}));

      return card;
    }

    /*****************
     * PRODUCT MODAL
     *****************/
    let pmCurrent = null;
    function openProductModal(p, {replaceHash=true}={}){
      pmCurrent = p;
      $("pmTitle").textContent = p.nombre;
      $("pmName").textContent = p.nombre;
      $("pmDesc").textContent = p.descripcion || "Sin descripción.";
      $("pmPrice").textContent = fmtLps(p.precio);
      $("pmStock").textContent = p.agotado ? "Agotado" : String(p.stock);
      $("pmCat").textContent = p.categoria;

      const pics = (p.galeria && p.galeria.length) ? p.galeria : (p.imagen ? [p.imagen] : []);
      const main = $("pmMain");
      const thumbs = $("pmThumbs");
      thumbs.innerHTML = "";
      if (!pics.length){
        main.innerHTML = `<div class="muted">Sin imagen</div>`;
      }else{
        let current = 0;
        const setMain = (i)=>{
          current = i;
          main.innerHTML = `<img src="${esc(pics[i])}" alt="${esc(p.nombre)}">`;
          Array.from(thumbs.children).forEach((b,bi)=>b.classList.toggle("active", bi===i));
        };
        pics.forEach((u,i)=>{
          const b = document.createElement("button");
          b.type="button";
          b.innerHTML = `<img src="${esc(u)}" alt="miniatura">`;
          b.addEventListener("click", ()=>setMain(i));
          thumbs.appendChild(b);
        });
        setMain(0);
      }

      $("pmAdd").disabled = p.agotado;
      $("pmAdd").onclick = ()=>addToCart(p.id, 1);
      $("pmCopy").onclick = ()=>{
        setHash({p: p.id, s:""});
        copyText(location.href);
        toast("Enlace del producto copiado");
      };

      $("productOverlay").classList.add("show");
      $("productOverlay").setAttribute("aria-hidden", "false");
      if (replaceHash) setHash({p: p.id});
    }

    function closeProductModal(updateHash=true){
      if (!$("productOverlay").classList.contains("show")) return;
      $("productOverlay").classList.remove("show");
      $("productOverlay").setAttribute("aria-hidden", "true");
      pmCurrent = null;
      if (updateHash) setHash({p:""});
    }

    /*****************
     * CART
     *****************/
    function loadCart(){
      try{
        const raw = localStorage.getItem("sdc_cart");
        const arr = JSON.parse(raw || "[]");
        if (Array.isArray(arr)) return arr.filter(x=>x && x.id && x.qty);
      }catch(e){}
      return [];
    }
    function saveCart(){
      localStorage.setItem("sdc_cart", JSON.stringify(state.cart));
    }

    function addToCart(productId, qty){
      const p = state.productById.get(productId);
      if (!p || p.agotado) return;
      const it = state.cart.find(x=>x.id===productId);
      if (it) it.qty = Math.min((it.qty||0) + qty, Math.max(1, p.stock || 99));
      else state.cart.push({id: productId, qty: Math.min(qty, Math.max(1, p.stock || 99))});
      saveCart();
      updateCartUI();
      toast("Agregado al carrito");
    }

    function setQty(productId, qty){
      const p = state.productById.get(productId);
      const it = state.cart.find(x=>x.id===productId);
      if (!it) return;
      const max = Math.max(1, p?.stock || 99);
      it.qty = Math.max(1, Math.min(qty, max));
      saveCart();
      updateCartUI();
      refreshShipping();
    }

    function removeFromCart(productId){
      state.cart = state.cart.filter(x=>x.id!==productId);
      saveCart();
      updateCartUI();
      refreshShipping();
    }

    function cartSubtotal(){
      let s = 0;
      for (const it of state.cart){
        const p = state.productById.get(it.id);
        if (!p) continue;
        s += (p.precio || 0) * (it.qty || 0);
      }
      return s;
    }

    function cartCount(){
      return state.cart.reduce((a,x)=>a+(x.qty||0),0);
    }

    function updateCartUI(){
      const count = cartCount();
      $("btnCart").setAttribute("data-badge", String(count));
      const bar = $("cartBar");
      if (count > 0){
        bar.classList.add("show");
        bar.setAttribute("aria-hidden","false");
        $("cartBarTitle").textContent = fmtLps(cartSubtotal());
        $("cartBarSub").textContent = count + " ítems";
      }else{
        bar.classList.remove("show");
        bar.setAttribute("aria-hidden","true");
      }

      // cart overlay content if open
      if ($("cartOverlay").classList.contains("show")){
        renderCartModal();
      }
    }

    function openCart(focusSend=false){
      renderCartModal();
      $("cartOverlay").classList.add("show");
      $("cartOverlay").setAttribute("aria-hidden","false");
      if (focusSend) setTimeout(()=>$("btnSend").focus(), 50);
      setHash({s:"carrito"});
    }
    function closeCart(){
      $("cartOverlay").classList.remove("show");
      $("cartOverlay").setAttribute("aria-hidden","true");
      if (state.route.s === "carrito") setHash({s:""});
    }

    function renderCartModal(){
      const list = $("cartList");
      const emptyMsg = $("cartEmptyMsg");
      list.innerHTML = "";
      if (!state.cart.length){
        emptyMsg.style.display = "block";
      }else{
        emptyMsg.style.display = "none";
        for (const it of state.cart){
          const p = state.productById.get(it.id);
          if (!p) continue;
          const div = document.createElement("div");
          div.className = "cartItem";
          const img = p.imagen || (p.galeria && p.galeria[0]) || "";
          div.innerHTML = `
            <img src="${esc(img)}" alt="${esc(p.nombre)}" onerror="this.style.display='none'">
            <div>
              <div class="ciName">${esc(p.nombre)}</div>
              <div class="ciMeta">${esc(fmtLps(p.precio))} · ${p.agotado ? "Agotado" : "Stock: " + p.stock}</div>
              <div class="ciMeta"><a href="#" data-open="${esc(p.id)}">Ver detalles</a></div>
            </div>
            <div class="qty">
              <button class="qbtn" data-dec="1" aria-label="Menos">−</button>
              <div class="qval">${it.qty}</div>
              <button class="qbtn" data-inc="1" aria-label="Más">+</button>
              <button class="qbtn" data-del="1" title="Quitar" aria-label="Quitar">✕</button>
            </div>
          `;
          // events
          div.querySelector("[data-open]").addEventListener("click",(e)=>{
            e.preventDefault();
            openProductModal(p, {replaceHash:true});
          });
          div.querySelector("[data-dec]").addEventListener("click", ()=>setQty(p.id, it.qty-1));
          div.querySelector("[data-inc]").addEventListener("click", ()=>setQty(p.id, it.qty+1));
          div.querySelector("[data-del]").addEventListener("click", ()=>removeFromCart(p.id));
          list.appendChild(div);
        }
      }

      // totals
      const sub = cartSubtotal();
      const disc = computeDiscount(sub);
      const ship = computeShippingCost();
      const shipText = state.shipCostText;

      $("tSubtotal").textContent = fmtLps(sub);
      $("tDiscount").textContent = fmtLps(disc);
      $("tShip").textContent = shipText;
      $("tTotal").textContent = fmtLps(Math.max(0, sub - disc + (Number.isFinite(ship) ? ship : 0)));

      refreshShipping();
    }

    /*****************
     * COUPONS
     *****************/
    function applyCoupon(){
      const code = norm($("coupon").value).toUpperCase();
      if (!code){
        state.couponApplied = null;
        $("couponHint").textContent = "";
        renderCartModal();
        toast("Cupón quitado");
        return;
      }
      const c = state.coupons.find(x=>x.code === code && x.activo);
      if (!c){
        state.couponApplied = null;
        $("couponHint").textContent = "Cupón no válido.";
        renderCartModal();
        return;
      }
      state.couponApplied = c;
      $("couponHint").textContent = "Cupón aplicado: " + c.code;
      renderCartModal();
      toast("Cupón aplicado");
    }

    function computeDiscount(subtotal){
      const c = state.couponApplied;
      if (!c) return 0;
      if (subtotal < (c.minimo || 0)) return 0;
      const v = c.valor;
      if (!Number.isFinite(v)) return 0;
      if (c.tipo.includes("POR") || c.tipo.includes("%")){
        return Math.round((subtotal * (v/100)) * 100) / 100;
      }
      return Math.min(subtotal, v);
    }

    /*****************
     * SHIPPING UI + COST
     *****************/
    function setVive(isComayagua){
      state.viveComayagua = isComayagua;
      $("btnViveSi").classList.toggle("active", isComayagua === true);
      $("btnViveNo").classList.toggle("active", isComayagua === false);

      $("comayaguaBlock").style.display = (isComayagua === true) ? "block" : "none";
      $("fueraBlock").style.display = (isComayagua === false) ? "block" : "none";
      $("viveHint").textContent = (isComayagua === true)
        ? "Comayagua: elige zona y forma de pago."
        : "Fuera de Comayagua: elige departamento, municipio, empresa y modalidad.";

      refreshShipping();
    }

    function populateColoniasFromShipping(){
      // take colonias from rows that look like Comayagua
      const dl = $("dlColonias");
      dl.innerHTML = "";
      const colset = new Set();
      for (const r of state.shippingRows){
        const a = normKey(r.area);
        if (a.includes("comayagua") && r.colonias){
          r.colonias.split(/[,\n]/).map(s=>s.trim()).filter(Boolean).forEach(x=>colset.add(x));
        }
      }
      Array.from(colset).sort((a,b)=>a.localeCompare(b,"es")).slice(0,250).forEach(c=>{
        const o = document.createElement("option");
        o.value = c;
        dl.appendChild(o);
      });
    }

    function initDepartamentos(){
      const deps = [
        "Atlántida","Choluteca","Colón","Comayagua","Copán","Cortés","El Paraíso","Francisco Morazán","Gracias a Dios",
        "Intibucá","Islas de la Bahía","La Paz","Lempira","Ocotepeque","Olancho","Santa Bárbara","Valle","Yoro"
      ];
      const depSel = $("dep");
      depSel.innerHTML = `<option value="">Selecciona</option>` + deps.map(d=>`<option value="${esc(d)}">${esc(d)}</option>`).join("");
      $("mun").innerHTML = `<option value="">Selecciona</option>`;
    }

    function populateMunicipiosFromShipping(){
      const dep = $("dep").value;
      const munSel = $("mun");
      const munSet = new Set();
      for (const r of state.shippingRows){
        if (!r.dept || !r.muni) continue;
        if (!dep || normKey(r.dept) === normKey(dep)){
          munSet.add(r.muni);
        }
      }
      const list = Array.from(munSet).sort((a,b)=>a.localeCompare(b,"es"));
      munSel.innerHTML = `<option value="">Selecciona</option>` + list.map(m=>`<option value="${esc(m)}">${esc(m)}</option>`).join("")
        + `<option value="Otro">Otro / No aparece</option>`;
    }

    function refreshShipping(){
      // compute and render totals row
      state.shipCost = computeShippingCost();
      // update totals in modal if open
      if ($("cartOverlay").classList.contains("show")){
        const sub = cartSubtotal();
        const disc = computeDiscount(sub);
        const ship = state.shipCost;
        $("tShip").textContent = state.shipCostText;
        $("tTotal").textContent = fmtLps(Math.max(0, sub - disc + (Number.isFinite(ship) ? ship : 0)));
      }
    }

    function computeShippingCost(){
      // No cart => no need
      if (!state.cart.length){
        state.shipCostText = "Por confirmar";
        return NaN;
      }
      if (state.viveComayagua === null){
        state.shipCostText = "Por confirmar";
        return NaN;
      }

      if (state.viveComayagua === true){
        const zona = norm($("zonaComa").value);
        if (!zona){
          state.shipCostText = "Por confirmar";
          return NaN;
        }
        // Match in ENVIOS first
        const row = findShippingRow({area:"comayagua", zona});
        const fallback = (zona==="CENTRICAS") ? 35 : (zona==="ALEJADAS") ? 50 : 100;
        const cost = row ? (Number.isFinite(row.tarifaNum) ? row.tarifaNum : asNumber(row.tarifaText)) : fallback;
        if (Number.isFinite(cost)){
          state.shipCostText = fmtLps(cost);
          return cost;
        }
        state.shipCostText = "Por confirmar";
        return NaN;
      }

      // Outside Comayagua
      const dept = norm($("dep").value);
      const muni = norm($("mun").value);
      const empresa = norm($("empresa").value);
      const modalidad = norm($("modalidad").value);
      if (!dept || !empresa || !modalidad){
        state.shipCostText = "Por confirmar";
        return NaN;
      }
      // if muni = Otro, treat as empty for matching
      const muniVal = muni==="Otro" ? "" : muni;

      const row =
        findShippingRow({area:"fuera", dept, muni: muniVal, empresa, modalidad}) ||
        findShippingRow({area:"fuera", dept, empresa, modalidad}) ||
        findShippingRow({area:"fuera", empresa, modalidad}) ||
        findShippingRow({empresa, modalidad});

      if (row){
        const cost = Number.isFinite(row.tarifaNum) ? row.tarifaNum : asNumber(row.tarifaText);
        if (Number.isFinite(cost)){
          state.shipCostText = fmtLps(cost);
          return cost;
        }
        if (row.tarifaText){
          state.shipCostText = row.tarifaText;
          return NaN;
        }
      }
      state.shipCostText = "Por confirmar";
      return NaN;
    }

    function findShippingRow({area, dept, muni, zona, empresa, modalidad}){
      const A = area ? normKey(area) : "";
      const D = dept ? normKey(dept) : "";
      const M = muni ? normKey(muni) : "";
      const Z = zona ? normKey(zona) : "";
      const E = empresa ? normKey(empresa) : "";
      const MOD = modalidad ? normKey(modalidad) : "";
      // rank by specificity
      let best=null, bestScore=-1;
      for (const r of state.shippingRows){
        let score=0;
        // area match (optional)
        if (A){
          const ra = normKey(r.area);
          if (A==="comayagua" && !ra.includes("comayagua")) continue;
          if (A==="fuera" && (ra.includes("comayagua") || ra.includes("local"))) continue;
          score += 1;
        }
        if (D){
          if (normKey(r.dept) !== D) continue;
          score += 2;
        }
        if (M){
          if (normKey(r.muni) !== M) continue;
          score += 3;
        }
        if (Z){
          if (normKey(r.zona) !== Z) continue;
          score += 3;
        }
        if (E){
          if (normKey(r.empresa) !== E) continue;
          score += 2;
        }
        if (MOD){
          if (normKey(r.modalidad) !== MOD) continue;
          score += 2;
        }
        // has tariff?
        if (r.tarifaText || Number.isFinite(r.tarifaNum)) score += 1;
        if (score > bestScore){ best=r; bestScore=score; }
      }
      return best;
    }

    /*****************
     * SEND ORDER (WhatsApp)
     *****************/
    function openWhatsAppChat(message){
      const url = "https://wa.me/" + encodeURIComponent(WHATSAPP_NUMBER) + "?text=" + encodeURIComponent(message);
      window.open(url, "_blank", "noopener");
    }

    function copyText(text){
      if (navigator.clipboard?.writeText){
        navigator.clipboard.writeText(text).catch(()=>fallbackCopy(text));
      }else fallbackCopy(text);
    }
    function fallbackCopy(text){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); }catch(e){}
      ta.remove();
    }

    function sendOrder(){
      if (!state.cart.length){
        openWhatsAppChat("Hola, quiero información del catálogo 🙂");
        return;
      }
      const name = norm($("custName").value);
      const phone = norm($("custPhone").value);
      if (!name || !phone){
        toast("Completa tu nombre y teléfono");
        openCart();
        return;
      }
      if (state.viveComayagua === null){
        toast("Selecciona si vives en Comayagua");
        openCart();
        return;
      }

      const sub = cartSubtotal();
      const disc = computeDiscount(sub);
      const ship = computeShippingCost();
      const shipLine = state.shipCostText;
      const total = Math.max(0, sub - disc + (Number.isFinite(ship) ? ship : 0));

      const lines = [];
      lines.push("🧾 *PEDIDO - Soluciones Digitales Comayagua*");
      lines.push("");
      lines.push("*Cliente:* " + name);
      lines.push("*Teléfono:* " + phone);
      lines.push("");

      lines.push("*Productos:*");
      for (const it of state.cart){
        const p = state.productById.get(it.id);
        if (!p) continue;
        lines.push(`- ${it.qty} × ${p.nombre} (${fmtLps(p.precio)}) = ${fmtLps(p.precio * it.qty)}`);
      }
      lines.push("");
      lines.push(`Subtotal: ${fmtLps(sub)}`);
      if (disc > 0) lines.push(`Descuento: -${fmtLps(disc)}${state.couponApplied ? " ("+state.couponApplied.code+")" : ""}`);
      lines.push(`Envío: ${shipLine}`);
      lines.push(`*TOTAL: ${fmtLps(total)}*`);
      lines.push("");

      if (state.viveComayagua === true){
        const zona = norm($("zonaComa").value);
        const colonia = norm($("coloniaComa").value);
        const pago = norm($("pagoComa").value);
        const dir = norm($("dirComa").value);
        if (!zona || !pago || !dir){
          toast("Completa zona, pago y dirección");
          openCart();
          return;
        }
        lines.push("*Entrega:* Comayagua (Local)");
        lines.push("*Zona:* " + zona);
        if (colonia) lines.push("*Colonia/Barrio:* " + colonia);
        lines.push("*Pago:* " + pago);
        if (pago === "TIGO MONEY"){
          lines.push("Tigo Money: +504 9474-6828 (Renee Gabriel Guerrero Coello)");
        }
        lines.push("*Dirección:* " + dir);
      }else{
        const dept = norm($("dep").value);
        const muni = norm($("mun").value);
        const empresa = norm($("empresa").value);
        const modalidad = norm($("modalidad").value);
        const dir = norm($("dirFuera").value);
        if (!dept || !empresa || !modalidad || !dir){
          toast("Completa departamento, empresa, modalidad y dirección");
          openCart();
          return;
        }
        lines.push("*Entrega:* Fuera de Comayagua");
        lines.push("*Departamento:* " + dept);
        if (muni && muni !== "Otro") lines.push("*Municipio:* " + muni);
        else if (muni === "Otro") lines.push("*Municipio:* (No aparece en lista)");
        lines.push("*Empresa:* " + empresa);
        lines.push("*Modalidad:* " + modalidad);
        lines.push("*Dirección:* " + dir);
      }

      lines.push("");
      lines.push("Link del carrito: " + location.origin + location.pathname + "#s=carrito");

      openWhatsAppChat(lines.join("\\n"));
    }

    /*****************
     * TESTIMONIALS
     *****************/
    function renderTestimonials(){
      const wrap = $("testiGrid");
      if (!state.testimonials.length){
        wrap.innerHTML = `
          <div class="mini"><b>Clientes felices</b><div class="muted">Pronto verás aquí testimonios desde Google Sheets.</div></div>
          <div class="mini"><b>Calidad</b><div class="muted">Atención rápida y productos confiables.</div></div>
          <div class="mini"><b>Soporte</b><div class="muted">Escríbenos por WhatsApp para ayudarte.</div></div>
        `;
        return;
      }
      wrap.innerHTML = "";
      const top = state.testimonials.slice(0, 12);
      for (const t of top){
        const stars = t.estrellas ? ("★".repeat(Math.min(5, Math.max(1, Math.round(t.estrellas))))).padEnd(5,"☆") : "";
        const div = document.createElement("div");
        div.className = "mini";
        div.innerHTML = `
          <b>${esc(t.nombre)} ${stars ? "· " + esc(stars) : ""}</b>
          <div class="muted">${esc(t.texto)}</div>
          ${t.fecha ? `<div class="muted" style="margin-top:8px">${esc(t.fecha)}</div>` : ""}
        `;
        wrap.appendChild(div);
      }
    }

    /*****************
     * INIT
     *****************/
    loadAll().catch(err=>{
      console.error(err);
      toast("Error cargando el catálogo. Revisa que Sheets esté publicado.");
      $("grid").innerHTML = "";
      $("empty").style.display = "block";
      $("empty").textContent = "Error cargando datos desde Google Sheets.";
    });
  </script>
</body>
</html>
