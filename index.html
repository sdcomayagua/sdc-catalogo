<!doctype html>
<html lang="es-HN" data-theme="cyberpunk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Soluciones Digitales Comayagua | Cat√°logo Gamer & Tecnolog√≠a</title>
  <meta name="description" content="Cat√°logo cyberpunk de Soluciones Digitales Comayagua. Accesorios gamer, tecnolog√≠a, ofertas reales y productos probados. Env√≠os a toda Honduras." />
  <meta name="theme-color" content="#0ef" />
  <link rel="preconnect" href="https://docs.google.com" crossorigin>
  <link rel="preconnect" href="https://lh3.googleusercontent.com" crossorigin>
  <style>
  /* ====== THEME (CYBERPUNK & NIGHT CITY) ====== */
  :root{
    --bg:#0b0f1a; --panel:#101629; --panel-2:#0f1430; --txt:#cfe8ff; --muted:#8ea3c5;
    --primary:#00eaff; --primary-2:#ff00e6; --ok:#00ffa7; --warn:#ffd166; --danger:#ff5f5f;
    --shadow:0 10px 30px rgba(0,0,0,.4), 0 0 30px rgba(0,234,255,.08);
  }
  [data-theme="nightcity"]{
    --bg:#0a0a0f; --panel:#141428; --panel-2:#101026; --txt:#e9f6ff; --muted:#a0b2d1;
    --primary:#ff007c; --primary-2:#00f0ff; --ok:#00ffb0; --warn:#ffd166; --danger:#ff5f5f;
    --shadow:0 10px 30px rgba(0,0,0,.5), 0 0 30px rgba(255,0,124,.08);
  }

  /* ====== BASE ====== */
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:linear-gradient(180deg,#070b16 0%,var(--bg) 40%,var(--bg) 100%);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Ubuntu,Inter,sans-serif}
  img{max-width:100%;display:block}
  a{color:var(--primary);text-decoration:none}
  .container{max-width:1100px;margin:auto;padding:0 16px}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:50;background:rgba(11,15,26,.75);backdrop-filter:saturate(160%) blur(10px);border-bottom:1px solid rgba(255,255,255,.06)}
  .topbar .container{display:flex;align-items:center;justify-content:space-between;height:64px}
  .brand{display:flex;gap:12px;align-items:center}
  .brand__logo{display:inline-grid;place-items:center;width:36px;height:36px;border:1px solid rgba(255,255,255,.15);border-radius:8px;background:radial-gradient(100% 100% at 50% 0%,rgba(0,234,255,.25),rgba(255,0,230,.15));box-shadow:0 0 18px rgba(0,234,255,.2) inset, 0 0 18px rgba(255,0,230,.15) inset}
  .brand__text{letter-spacing:.2px;color:var(--txt)}
  .top-actions{display:flex;gap:8px;align-items:center}
  .badge{background:var(--primary-2);color:#fff;border-radius:999px;padding:2px 6px;font-size:12px;margin-left:4px}

  /* Buttons */
  .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:.65rem 1rem;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));color:var(--txt);cursor:pointer}
  .btn:hover{border-color:rgba(255,255,255,.28)}
  .btn-ghost{background:transparent;border-color:rgba(255,255,255,.12)}
  .btn-primary{background:linear-gradient(90deg,var(--primary),var(--primary-2));border-color:transparent;color:#001018}
  .glow{box-shadow:0 0 22px rgba(0,234,255,.35), 0 0 22px rgba(255,0,230,.25)}
  .switch{display:flex;align-items:center;gap:.5rem}
  .icon-btn{display:inline-grid;place-items:center;width:38px;height:38px;border-radius:10px;border:1px solid rgba(255,255,255,.12);cursor:pointer}

  /* Icons */
  .i{width:22px;height:22px;fill:currentColor}

  /* Hero */
  .hero{position:relative;padding:56px 0 32px;border-bottom:1px solid rgba(255,255,255,.06)}
  .hero__content{text-align:center}
  .hero h1{font-size:clamp(28px,5vw,48px);margin:.25rem 0 0}
  .hero p{color:var(--muted);margin:.5rem 0 1rem}
  .hero__cta{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .glitch{position:relative;display:inline-block;line-height:1.08;text-shadow:0 0 10px rgba(0,234,255,.55), 0 0 18px rgba(255,0,230,.28)}
  .glitch:before,.glitch:after{content:attr(data-text);position:absolute;left:0;top:0;width:100%;pointer-events:none}
  .glitch:before{transform:translate(1px,0);clip-path:inset(0 0 55% 0);color:#0ff;opacity:.45}
  .glitch:after{transform:translate(-1px,0);clip-path:inset(55% 0 0 0);color:#f0f;opacity:.35}
  @media (max-width: 640px){.glitch:before,.glitch:after{display:none}}
.scanlines:before{content:"";position:absolute;inset:0;background:repeating-linear-gradient(to bottom,rgba(255,255,255,.02) 0 2px,transparent 2px 4px);pointer-events:none}

  /* Filters */
  .filters{padding:18px 0}
  .filter-row{display:grid;gap:10px;grid-template-columns:1fr;align-items:end}
  .field{display:grid;gap:6px}
  .field input,.field select{border:1px solid rgba(255,255,255,.15);background:var(--panel);color:var(--txt);border-radius:10px;padding:.7rem .8rem;outline:none}
  .field input:focus,.field select:focus{border-color:var(--primary)}
  @media (min-width:720px){ .filter-row{grid-template-columns:1.4fr .8fr .8fr .6fr} }

  /* Grid de productos */
  .grid{display:grid;gap:14px;grid-template-columns:repeat(1,1fr)}
  @media (min-width:550px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}

  .card{position:relative;border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,var(--panel),var(--panel-2));border-radius:14px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
  .card__img{aspect-ratio:1.1/1;background:#0a1120;display:block;object-fit:cover;width:100%;filter:contrast(1.05) saturate(1.1)}
  .card__body{padding:12px 12px 14px;display:grid;gap:8px}
  .card h4{margin:.2rem 0 .1rem;font-size:1rem;line-height:1.2}
  .price{display:flex;gap:8px;align-items:baseline}
  .price .now{color:var(--ok);font-weight:700}
  .price .old{color:var(--muted);text-decoration:line-through}
  .badges{position:absolute;top:10px;left:10px;display:flex;gap:6px;flex-wrap:wrap}
  .badge-chip{background:linear-gradient(90deg,rgba(0,234,255,.3),rgba(255,0,230,.25));border:1px solid rgba(255,255,255,.2);border-radius:999px;padding:4px 8px;font-size:12px;color:#e9fbff}
  .stars{color:#ffd166;font-size:14px}
  .card__actions{display:flex;gap:8px;margin-top:6px}
  .card__actions .btn{flex:1}
  .skeleton-grid{display:grid;grid-template-columns:inherit;gap:14px}
  .skeleton{height:280px;border-radius:14px;background:linear-gradient(90deg,#0e162c,#121a34,#0e162c);background-size:200% 100%;animation:pulse 1.2s infinite}
  @keyframes pulse{0%{background-position:0 0}100%{background-position:200% 0}}

  /* Drawer carrito */
  .drawer{position:fixed;top:0;right:0;height:100dvh;width:min(420px,92vw);background:linear-gradient(180deg,var(--panel-2),#0b0f1a);border-left:1px solid rgba(255,255,255,.08);transform:translateX(110%);transition:transform .35s ease;z-index:100}
  .drawer.open{transform:translateX(0)}
  .drawer__header{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid rgba(255,255,255,.08)}
  .drawer__body{padding:14px;display:grid;gap:12px}
  .cart-list{list-style:none;margin:0;padding:0;display:grid;gap:10px;max-height:40vh;overflow:auto}
  .cart-item{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;border:1px solid rgba(255,255,255,.08);padding:8px;border-radius:10px}
  .cart-item img{width:64px;height:64px;object-fit:cover;border-radius:8px}
  .qty{display:inline-flex;align-items:center;gap:6px}
  .qty button{width:28px;height:28px;border-radius:8px}
  .summary{display:grid;gap:8px;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px}
  .summary .total{border-top:1px dashed rgba(255,255,255,.18);padding-top:8px}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;visibility:hidden;transition:.3s;z-index:90}
  .overlay.show{opacity:1;visibility:visible}

  /* Modal detalles (galer√≠a) */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);z-index:120}
  .modal.open{display:grid}
  .modal__card{width:min(920px,94vw);max-height:92vh;overflow:auto;background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.1);border-radius:14px;box-shadow:var(--shadow);padding:12px}
  .gallery{position:relative}
  .gallery-main{aspect-ratio:1.4/1;background:#0a1120;border-radius:10px;overflow:hidden}
  .gallery-main img{width:100%;height:100%;object-fit:contain}
  .thumbs{margin-top:8px;display:grid;grid-template-columns:repeat(auto-fill,minmax(74px,1fr));gap:8px}
  .thumbs img{width:100%;height:74px;object-fit:cover;border:1px solid rgba(255,255,255,.12);border-radius:8px;cursor:pointer;opacity:.85}
  .thumbs img.active{border-color:var(--primary);opacity:1}

  /* Secciones extra */
  .trust,.ratings,.location,.faq,.privacy{padding:24px 0}
  .trust .container{display:grid;gap:12px}
  @media(min-width:820px){.trust .container{grid-template-columns:repeat(3,1fr)}}
  .trust article{border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;background:linear-gradient(180deg,var(--panel),var(--panel-2));box-shadow:var(--shadow)}
  .footer{border-top:1px solid rgba(255,255,255,.08);padding:18px 0;background:rgba(255,255,255,.02)}

  /* Utils */
  .hidden{display:none}
  .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);margin:6px 0}
  .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.12);z-index:999;display:none}
  .toast.show{display:block}
  
  details.privacy-details{margin:18px 0;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(255,255,255,.03);padding:10px}
  details.privacy-details>summary{cursor:pointer;list-style:none;font-weight:700;display:flex;align-items:center;justify-content:space-between;gap:10px}
  details.privacy-details>summary::-webkit-details-marker{display:none}
  details.privacy-details .privacy-body{padding:10px 4px 0;color:rgba(255,255,255,.85)}
  .hashlink,.hash{font-weight:700;color:rgba(0,234,255,.9);text-decoration:none}
  .hashlink:hover{text-decoration:underline}
</style>
</head>
<body>
  <!-- Barra superior -->
  <header class="topbar">
    <div class="container">
      <a class="brand" href="#">
        <span class="brand__logo" aria-hidden="true">SDC</span>
        <span class="brand__text">Soluciones Digitales <b>Comayagua</b></span>
      </a>
      <nav class="top-actions" aria-label="Acciones">
        <button class="btn btn-ghost" id="btn-search" aria-label="Buscar"><svg class="i i-search" viewBox="0 0 24 24"><path d="M10 4a6 6 0 014.472 9.972l4.278 4.278-1.414 1.414-4.278-4.278A6 6 0 1110 4z"/></svg></button>
        <button class="btn btn-ghost" id="btn-theme" title="Cambiar tema" aria-label="Cambiar tema">üåì</button>
        <button class="btn btn-ghost" id="btn-cart" aria-label="Carrito">
          <svg class="i i-cart" viewBox="0 0 24 24"><path d="M7 4h-2l-1 2v2h2l3.6 7.59L8 19a2 2 0 104 0h4a2 2 0 104 0h-1"/></svg>
          <span class="badge" id="cart-count">0</span>
        </button>
        <a class="btn btn-primary glow" href="https://wa.me/50432429490" target="_blank" rel="noopener">WhatsApp</a>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="scanlines" aria-hidden="true"></div>
    <div class="container hero__content">
      <h1 class="glitch" data-text="Tecnolog√≠a & Accesorios Gamer">Tecnolog√≠a & Accesorios Gamer</h1>
      <p>Env√≠os a toda Honduras ‚Ä¢ Ofertas reales ‚Ä¢ Productos probados ‚Ä¢ Atenci√≥n por WhatsApp</p>
      <div class="hero__cta">
        <button class="btn btn-primary glow" id="btn-view-offers" type="button">üî• Ver Ofertas</button>
        <button class="btn btn-ghost" id="scroll-search">üîé Buscar Cat√°logo</button>
      </div>
    </div>
  </section>

  <!-- Filtros -->
  <section class="filters container" id="buscar">
    <div class="filter-row">
      <label class="field">
        <span>Buscar producto</span>
        <input id="q" type="search" placeholder="Ej.: mouse, aud√≠fonos, teclado..." inputmode="search" />
      </label>
      <label class="field">
        <span>Categor√≠a</span>
        <select id="cat"><option value="">Todas</option></select>
      </label>
      <label class="field">
        <span>Rango de precio</span>
        <input id="priceMin" type="number" placeholder="M√≠n" min="0" />
        <input id="priceMax" type="number" placeholder="M√°x" min="0" />
      </label>
      <label class="switch">
        <input type="checkbox" id="onlyOffers" />
        <span>Solo ofertas</span>
      </label>
    </div>
  </section>

  <!-- Cat√°logo -->
  <main id="catalogo" class="container">
    <div id="grid" class="grid">
      <div class="skeleton-grid" id="skeleton"></div>
    </div>
    <div class="empty hidden" id="empty">
      <p>No se encontraron productos con esos filtros.</p>
    </div>
  </main>

  <!-- Drawer Carrito -->
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer__header">
      <h2>Tu Carrito</h2>
      <button class="btn btn-ghost" id="close-drawer" aria-label="Cerrar">‚úï</button>
    </div>
    <div class="drawer__body">
      <ul id="cart-list" class="cart-list"></ul>
      <div class="divider"></div>

      <form id="checkout-form" class="checkout">
        <h3>Entrega y pago</h3>

        <div class="radio-row">
          <span>¬øEst√°s en Comayagua?</span>
          <label><input type="radio" name="isComayagua" value="si" checked /> S√≠</label>
          <label><input type="radio" name="isComayagua" value="no" /> No</label>
        </div>

        <label class="field">
          <span>Direcci√≥n exacta</span>
          <input id="addr" type="text" placeholder="Barrio/colonia, calle, #casa, referencia" />
        </label>

        <label class="field">
          <span>Empresa de env√≠o</span>
          <select id="shipper">
            <option value="">Selecciona‚Ä¶</option>
            <option value="Local">Reparto Local</option>
            <option value="C807">C807</option>
            <option value="Cargo Expreso">Cargo Expreso</option>
            <option value="Forza">Forza</option>
          </select>
        </label>

        <label class="field" id="field-zone" style="display:none">
          <span>Zona (Comayagua)</span>
          <select id="zone"></select>
          <small style="color:var(--muted)">Tip: se detecta por colonia si tu direcci√≥n coincide.</small>
        </label>

        <label class="field">
          <span>Departamento</span>
          <input id="dept" type="text" placeholder="Ej.: Comayagua" />
        </label>

        <label class="field">
          <span>Municipio</span>
          <input id="muni" type="text" placeholder="Ej.: Comayagua" />
        </label>

        <div class="radio-row">
          <span>M√©todo de pago</span>
          <label><input type="radio" name="payMode" value="Prepago" checked /> Prepago</label>
          <label><input type="radio" name="payMode" value="PAGAR AL RECIBIR" /> Pagar al recibir</label>
        </div>

        <label class="field">
          <span>Cup√≥n de descuento</span>
          <div style="display:flex;gap:6px">
            <input id="coupon" type="text" placeholder="Ej.: SDC10" />
            <button type="button" class="btn btn-ghost" id="btn-apply-coupon">Aplicar</button>
          </div>
        </label>

        <div class="summary">
          <div><span>Subtotal</span><b id="subtotal" style="float:right">L 0.00</b></div>
          <div id="discountRow" class="hidden"><span>Descuento</span><b id="discount" style="float:right">- L 0.00</b></div>
          <div><span>Env√≠o</span><b id="shipping" style="float:right">A calcular</b></div>
          <div class="total"><span>Total</span><b id="grand" style="float:right">L 0.00</b></div>
        </div>

        <button type="submit" class="btn btn-primary glow" id="btn-whatsapp">Enviar pedido por WhatsApp üöÄ</button>
        <p class="help">Tip: se calcula autom√°ticamente seg√∫n zona/empresa y cup√≥n ‚úÖ</p>
      </form>
    </div>
  </aside>

  <!-- Overlay -->
  <div id="overlay" class="overlay" tabindex="-1" aria-hidden="true"></div>

  <!-- Secciones extra -->
  <section class="trust container">
    <article>
      <h3>Env√≠os a toda HN</h3>
      <p>Trabajamos con C807, Forza y Cargo Expreso.</p>
    </article>
    <article>
      <h3>Compra segura</h3>
      <p>Productos probados y reales, soporte por WhatsApp.</p>
    </article>
    <article>
      <h3>Atenci√≥n real</h3>
      <p>Estamos en Comayagua. Pagar al recibir seg√∫n empresa.</p>
    </article>
  </section>

  <section class="ratings container">
    <h3>‚≠ê Lo que dicen los Gamers</h3>
    <div class="quotes">
      <blockquote>‚ÄúEntrega r√°pida y el mouse gamer sali√≥ buen√≠simo.‚Äù</blockquote>
      <blockquote>‚ÄúBuena atenci√≥n, me ayudaron a elegir teclado.‚Äù</blockquote>
    </div>
  </section>

  <section class="location container">
    <h3>üìç Ubicaci√≥n</h3>
    <p>Toca tu app favorita para ver la tienda:</p>
    <p>
      <a class="btn btn-ghost" target="_blank" rel="noopener" href="https://maps.app.goo.gl/uDTJRhm7uXLLWuZj6">Google Maps</a>
      <a class="btn btn-ghost" target="_blank" rel="noopener" href="https://waze.com/ul?q=Soluciones%20Digitales%20Comayagua&navigate=yes">Waze</a>
      <a class="btn btn-ghost" target="_blank" rel="noopener" href="https://maps.apple.com/?q=Soluciones%20Digitales%20Comayagua">Apple Maps</a>
    </p>
  </section>

  <section class="faq container" id="faq">
    <h3>‚ùì Preguntas Frecuentes</h3>
    <details open>
      <summary>¬øHacen env√≠os a toda Honduras?</summary>
      <p>¬°Claro! üöö C807, Forza y Cargo Expreso. Tambi√©n pod√©s coordinar en Comayagua.</p>
    </details>
    <details>
      <summary>¬øQu√© m√©todos de pago aceptan?</summary>
      <p>Efectivo y transferencia. Contra entrega cuando aplique (lo cobra la empresa).</p>
    </details>
    <details>
      <summary>¬øC√≥mo puedo comprar?</summary>
      <p>Elige el producto y toca <b>‚ÄúPedir ahora üöÄ‚Äù</b>. Te llevo a WhatsApp con el mensaje listo.</p>
    </details>
  </section>

  <footer class="footer">
    <div class="container">
      <p>¬© 2026 Soluciones Digitales Comayagua ‚Äî Todos los derechos reservados.</p>
      <a href="#privacidad">Pol√≠tica de privacidad</a> <a class="hashlink" href="#privacidad">#privacidad</a>
      <div class="social">
        <a href="https://www.facebook.com/sdcomayagua/" aria-label="Facebook" target="_blank" rel="noopener">FB</a>
        <a href="https://www.instagram.com/sdcomayagua/" aria-label="Instagram" target="_blank" rel="noopener">IG</a>
        <a href="https://www.tiktok.com/@gamer.comayagua" aria-label="TikTok" target="_blank" rel="noopener">TT</a>
      </div>
    </div>
  </footer>

  <section class="privacy container">
    <details id="privacidad" class="privacy-details">
      <summary>
        <span>üîí Pol√≠tica de privacidad</span>
        <span class="hash">#privacidad</span>
      </summary>
      <div class="privacy-body">
<p>En SDC respetamos tu privacidad. Esta pol√≠tica explica c√≥mo se maneja la informaci√≥n cuando visitas este cat√°logo y cuando realizas un pedido por WhatsApp.</p>
        <ol>
          <li><b>Informaci√≥n que se recopila:</b> nombre, tel√©fono, direcci√≥n/referencias de entrega, productos y cantidades seleccionadas. Adem√°s, el sitio puede guardar preferencias (por ejemplo, tu carrito) en tu navegador (<i>localStorage</i>).</li>
          <li><b>Uso de la informaci√≥n:</b> preparar tu pedido, calcular/coordinar el env√≠o, darte soporte por WhatsApp y mejorar la experiencia del cat√°logo.</li>
          <li><b>Con qui√©n se comparte:</b> no vendemos tus datos. Solo se comparten con WhatsApp (para enviar el mensaje del pedido) y con la empresa de mensajer√≠a cuando aplica.</li>
          <li><b>Servicios de terceros:</b> WhatsApp, redes sociales y Google/Sheets pueden tener sus propias pol√≠ticas de privacidad.</li>
          <li><b>Tus opciones:</b> pod√©s pedir correcci√≥n o eliminaci√≥n de datos escribiendo al WhatsApp de contacto. Tambi√©n pod√©s borrar el carrito limpiando datos del navegador.</li>
          <li><b>Contacto:</b> WhatsApp: +504 3242-9490 ‚Äî Atenci√≥n en Comayagua, Honduras.</li>
        </ol>
      </div>
    </details>
  </section>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  
  <script>
  /* ======= CONFIG (Google Sheets) =======
     - Hoja de configuraci√≥n: _config (col A: sheet)
     - Hojas de productos: ofertas, gamer, pc, movil, streaming, cobertores, power (y las que agregues)
     - Hoja de env√≠os: envios (empresa, area, zona, modalidad, colonias, tarifa)
  */
  const CONFIG = {
    // ‚úÖ Tu SHEET_ID real (no lo cambio a menos que lo pidas)
    SHEET_ID: "1pp4fQRoy9hI5aqFaEGkqIpMSb2v85FP3MgBhCqrnmt4",

    SHEET_CONFIG: "_config",
    SHEET_SHIPPING_CANDIDATES: ["envios", "Envios", "Env√≠os", "ENV√çOS"],
    SHEET_COUPONS_CANDIDATES: ["cupones", "Cupones", "CUPONES"],

    WHATSAPP_NUMBER: "50432429490",
    CURRENCY: "HNL",
    LOCALE: "es-HN",

    // fallback por si _config no est√° p√∫blico
    PRODUCT_SHEETS_FALLBACK: ["ofertas","gamer","pc","movil","streaming","cobertores","power"]
  };

  const state = {
    all: [],
    filtered: [],
    cart: loadCart(),
    categories: new Set(),
    shippingMap: {},
    coupons: {},
    couponApplied: null,
    productSheets: []
  };

  const els = {
    grid: document.getElementById("grid"),
    skeleton: document.getElementById("skeleton"),
    empty: document.getElementById("empty"),
    q: document.getElementById("q"),
    cat: document.getElementById("cat"),
    priceMin: document.getElementById("priceMin"),
    priceMax: document.getElementById("priceMax"),
    onlyOffers: document.getElementById("onlyOffers"),
    cartCount: document.getElementById("cart-count"),
    drawer: document.getElementById("drawer"),
    overlay: document.getElementById("overlay"),
    subtotal: document.getElementById("subtotal"),
    shipping: document.getElementById("shipping"),
    grand: document.getElementById("grand"),
    checkoutForm: document.getElementById("checkout-form"),
    cartList: document.getElementById("cart-list"),
    shipper: document.getElementById("shipper"),
    addr: document.getElementById("addr"),
    dept: document.getElementById("dept"),
    muni: document.getElementById("muni"),
    discountRow: document.getElementById("discountRow"),
    discount: document.getElementById("discount"),
    coupon: document.getElementById("coupon"),
    btnApplyCoupon: document.getElementById("btn-apply-coupon"),
    zoneField: document.getElementById("field-zone"),
    zoneSel: document.getElementById("zone"),
    btnTheme: document.getElementById("btn-theme"),
    toast: document.getElementById("toast"),
    btnViewOffers: document.getElementById("btn-view-offers")
  };

  function money(n){ return (Number(n||0)).toLocaleString(CONFIG.LOCALE,{style:"currency",currency:CONFIG.CURRENCY}); }
  function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }
  function toast(msg){ els.toast.textContent = msg; els.toast.classList.add("show"); setTimeout(()=>els.toast.classList.remove("show"), 2200); }

  function parseMoney(v){
    if(v===null || v===undefined) return 0;
    const s = String(v).replace(/[\s,L]/g,"").replace(/[^\d.]/g,"");
    const n = parseFloat(s);
    return isFinite(n) ? n : 0;
  }

  /* ===== Sheets fetchers (GViz/CSV) ===== */
  async function fetchGViz(sheetName){
    const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&headers=1&sheet=${encodeURIComponent(sheetName)}`;
    const res = await fetch(url);
    const txt = await res.text();

    if(!res.ok) throw new Error(`GViz HTTP ${res.status}`);
    if(/<html|<!doctype/i.test(txt)) throw new Error("GViz devolvi√≥ HTML (¬øhoja privada o no publicada?)");

    const m = txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\)\s*;?\s*$/);
    if(!m) throw new Error("GViz parse error");

    const json = JSON.parse(m[1]);
    const cols = (json.table.cols || []).map(c => (c.label || c.id || "").toString().trim());
    const rows = (json.table.rows || []).map(r => {
      const o = {};
      (r.c || []).forEach((cell,i)=>{ o[cols[i] || ("col"+i)] = cell ? (cell.f ?? cell.v) : null; });
      return o;
    });
    return rows;
  }

  function splitCsvLine(line){
    return String(line || "")
      .split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
      .map(v=>v.replace(/^"|"$/g,"").trim());
  }

  async function fetchCSV(sheetName){
    const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&headers=1&sheet=${encodeURIComponent(sheetName)}`;
    const res = await fetch(url);
    const csv = await res.text();

    if(!res.ok) throw new Error(`CSV HTTP ${res.status}`);
    if(/<html|<!doctype/i.test(csv)) throw new Error("CSV devolvi√≥ HTML (¬øhoja privada o no publicada?)");

    const lines = csv.trim().split(/\r?\n/).filter(Boolean);
    const head = splitCsvLine(lines.shift() || "");
    const cols = head;

    return lines.map(l=>{
      const vals = splitCsvLine(l);
      const o = {};
      cols.forEach((c,i)=>o[c]=vals[i]);
      return o;
    });
  }

  function looksGenericCols(cols){
    return (cols || []).length && cols.every(c => /^([A-Z]{1,3}|col\d+)$/.test(String(c||"")));
  }

  function fixHeadersIfNeeded(rows){
    if(!rows || rows.length < 2) return rows;
    const cols = Object.keys(rows[0] || {});
    if(!looksGenericCols(cols)) return rows;

    const first = rows[0] || {};
    const headers = cols.map(c => String(first[c] ?? "").trim());
    const joined = headers.join(" ").toLowerCase();
    const hasReal = ["nombre","precio","categoria","imagen","stock","estado","subcategoria","descripcion","whatsapp"].some(k => joined.includes(k));
    if(!hasReal) return rows;

    return rows.slice(1).map(r=>{
      const o = {};
      cols.forEach((c,i)=>{
        const h = headers[i] || c;
        o[h] = r[c];
      });
      return o;
    });
  }

  async function fetchSheetRows(sheetName){
    let rows;
    try{ rows = await fetchGViz(sheetName); }
    catch(e1){ rows = await fetchCSV(sheetName); }
    return fixHeadersIfNeeded(rows);
  }

  /* ====== Leer lista de hojas desde _config ====== */
  function normalizeSheetName(s){ return (s||"").toString().trim(); }

  async function loadProductSheets(){
    try{
      const rows = await fetchSheetRows(CONFIG.SHEET_CONFIG);
      const values = rows
        .map(r => r.sheet ?? r.SHEET ?? r.Sheet ?? Object.values(r)[0])
        .map(normalizeSheetName)
        .filter(Boolean)
        .filter(v => v.toLowerCase() !== "sheet");

      const cleaned = values.filter(v=>{
        const low = v.toLowerCase();
        if(low.startsWith("_")) return false;
        if(low === "testimonios") return false;
        if(low === "envios" || low === "env√≠os" || low === "envios ") return false;
        if(low === "cupones") return false;
        return true;
      });

      state.productSheets = cleaned.length ? cleaned : CONFIG.PRODUCT_SHEETS_FALLBACK;
    }catch(e){
      console.warn("No se pudo leer _config, usando fallback", e);
      state.productSheets = CONFIG.PRODUCT_SHEETS_FALLBACK;
    }
  }

  /* ==== Map flexible headers (Products) ==== */
  function mapProduct(row, sheetName){
    const keys = Object.keys(row || {});
    const pickKey = (want)=> keys.find(k => want.includes(String(k).toLowerCase().trim()));
    const get = (want, def=null)=>{
      const k = pickKey(want.map(x=>x.toLowerCase()));
      return k ? row[k] : def;
    };

    const nombre = (get(["nombre","producto","t√≠tulo","titulo","name"]) || "").toString().trim();
    if(!nombre) return null;

    const precioNow = parseMoney(get(["precio","precio_actual","price"], 0));
    const precioAntes = parseMoney(get(["precio_anterior","precio antes","antes","old","precio_regular","precio lista","precio_lista"], 0));

    // Modelo interno: precio = regular, promo = oferta
    let precio = precioNow;
    let promo = 0;
    if(precioAntes > 0 && precioNow > 0 && precioNow < precioAntes){
      precio = precioAntes;
      promo = precioNow;
    }

    const stock = parseInt(get(["stock","inventario","existencia","qty"], "0")) || 0;

    const estadoRaw = (get(["estado","estatus","status"], "") || "").toString().trim().toLowerCase();
    const oculto = estadoRaw.includes("inactivo") || estadoRaw.includes("oculto") || estadoRaw.includes("hidden");
    const agotadoEstado = estadoRaw.includes("agotado");

    const categoria = (get(["categoria","categor√≠a","rubro","tag","tipo"], sheetName) || sheetName).toString().trim() || "General";
    const subcategoria = (get(["subcategoria","sub-categoria","sub"], "") || "").toString().trim();

    const imagen = (get(["imagen","foto","url_imagen","image"], "") || "").toString().trim();
    const galeria = (get(["galeria","galer√≠a","imagenes","images","gallery"], "") || "").toString();
    const images = [];
    if(galeria){
      galeria.split(/\||,|\s+/).map(s=>s.trim()).filter(Boolean).forEach(u=>images.push(u));
    }
    if(imagen && !images.length) images.push(imagen);

    const desc = (get(["descripcion","descripci√≥n","detalle","beneficio","about"], "") || "").toString().trim();
    const soloOfertas = String(get(["solo_ofertas","solo ofertas","soloofertas"], "") || "").toLowerCase().includes("s") || String(get(["solo_ofertas"], "")).includes("1");

    const instagram = (get(["instagram"], "") || "").toString().trim();
    const facebook  = (get(["facebook"], "") || "").toString().trim();
    const whatsapp  = (get(["whatsapp"], "") || "").toString().trim();

    return {
      nombre,
      precio,
      promo,
      imagen,
      images,
      categoria,
      subcategoria,
      stock,
      desc,
      soloOfertas,
      agotado: (stock <= 0) || agotadoEstado,
      visible: !oculto,
      links: { instagram, facebook, whatsapp },
      sheet: sheetName
    };
  }

  /* ====== Load data ====== */
  async function loadData(){
    els.skeleton.innerHTML = Array.from({length:9}, ()=>'<div class="skeleton"></div>').join('');
    try{
      await loadProductSheets();

      // Productos (todas las hojas de _config)
      const sheetFetches = state.productSheets.map(async (sheetName)=>{
        const rows = await fetchSheetRows(sheetName);
        return rows.map(r => mapProduct(r, sheetName)).filter(Boolean);
      });

      const allArrays = await Promise.all(sheetFetches);
      const products = allArrays.flat().filter(p => p.visible);

      // Envios (si existe)
      try{ await loadShippingAdvanced(); } catch(e){ console.warn("Envios no carg√≥:", e); }

      // Cupones (opcional)
      try{ await loadCoupons(); } catch(e){ console.warn("Cupones no carg√≥:", e); }

      state.all = products;

      // Categor√≠as: prioriza columna categoria, pero si viene vac√≠a usa nombre de hoja
      state.categories = new Set(products.map(p=>p.categoria).filter(Boolean));
      populateFilters();
      applyFilters();

      // defaults en checkout
      syncCheckoutUI();
      updateCartCount();
    }catch(e){
      console.error(e);
      els.skeleton.innerHTML = `<p style="padding:16px">Error cargando el cat√°logo. Revisa que tu Google Sheets est√© <b>Publicado</b> (Archivo ‚Üí Publicar en la web) y que el SHEET_ID sea correcto.</p>`;
    }
  }

  function populateFilters(){
    els.cat.innerHTML = '<option value="">Todas</option>' + [...state.categories].sort((a,b)=>a.localeCompare(b)).map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
  }

  function applyFilters(){
    const q = (els.q.value || "").toLowerCase().trim();
    const cat = els.cat.value;
    const min = parseFloat(els.priceMin.value) || 0;
    const max = parseFloat(els.priceMax.value) || Infinity;
    const onlyOffers = els.onlyOffers.checked;

    state.filtered = state.all.filter(p=>{
      const text = [p.nombre,p.categoria,p.subcategoria,p.desc,p.sheet].filter(Boolean).join(" ").toLowerCase();
      const inText = !q || text.includes(q);
      const inCat = !cat || p.categoria === cat;
      const priceNow = (p.promo > 0 && p.promo < p.precio) ? p.promo : p.precio;
      const inRange = priceNow >= min && priceNow <= max;

      const isOffer = (p.promo > 0 && p.promo < p.precio) || p.soloOfertas || (p.sheet && p.sheet.toLowerCase()==="ofertas");
      const offerOk = !onlyOffers || isOffer;

      return inText && inCat && inRange && offerOk;
    });

    renderGrid();
  }

  function renderStars(){
    // reservado por si luego agreg√°s rating
    return "";
  }

  function renderGrid(){
    els.grid.innerHTML = "";
    els.skeleton.style.display = "none";

    if(state.filtered.length === 0){
      els.empty.classList.remove("hidden");

      if((state.all || []).length === 0){
        els.empty.innerHTML = `<p><b>No se pudo cargar tu cat√°logo desde Google Sheets.</b><br>
        Revis√°: (1) Compartir: <b>Cualquier persona con el enlace ‚Üí Lector</b> (2) <b>Archivo ‚Üí Publicar en la web</b> (3) Encabezados en la fila 1: <b>categoria, nombre, precio, stock, imagen</b>.<br>
        Luego recarg√° la p√°gina.</p>`;
      }else{
        els.empty.innerHTML = `<p>No se encontraron productos con esos filtros.</p>`;
      }
      return;
    }
    els.empty.classList.add("hidden");

    const frag = document.createDocumentFragment();

    state.filtered.forEach(p=>{
      const card = document.createElement("article");
      card.className = "card";

      const img = document.createElement("img");
      img.className = "card__img";
      img.loading = "lazy";
      img.alt = p.nombre;
      img.src = (p.images && p.images[0]) || p.imagen || "";

      const body = document.createElement("div");
      body.className = "card__body";

      const h4 = document.createElement("h4");
      h4.textContent = p.nombre;

      const pdesc = document.createElement("p");
      pdesc.textContent = p.desc || (p.subcategoria ? p.subcategoria : "‚Äî");
      pdesc.style.color = "var(--muted)";
      pdesc.style.fontSize = ".9rem";

      const price = document.createElement("div");
      price.className = "price";

      const now = document.createElement("span");
      now.className = "now";
      const old = document.createElement("span");
      old.className = "old";

      const final = (p.promo > 0 && p.promo < p.precio) ? p.promo : p.precio;
      now.textContent = money(final);

      if(p.promo > 0 && p.promo < p.precio){
        old.textContent = money(p.precio);
        price.append(now, old);
      }else{
        price.append(now);
      }

      const actions = document.createElement("div");
      actions.className = "card__actions";

      const btnAdd = document.createElement("button");
      btnAdd.className = "btn btn-primary glow";
      btnAdd.textContent = "Pedir ahora üöÄ";
      btnAdd.onclick = ()=>addToCart(p);

      const btnGhost = document.createElement("button");
      btnGhost.className = "btn btn-ghost";
      btnGhost.textContent = "Detalles";
      btnGhost.onclick = ()=>showDetails(p);

      actions.append(btnAdd, btnGhost);

      const badges = document.createElement("div");
      badges.className = "badges";

      if(p.promo > 0 && p.promo < p.precio){
        const b = document.createElement("span");
        b.className="badge-chip";
        b.textContent="OFERTA";
        badges.appendChild(b);
      }

      if(p.agotado){
        const b = document.createElement("span");
        b.className="badge-chip";
        b.textContent="AGOTADO";
        badges.appendChild(b);
        btnAdd.disabled = true;
        btnAdd.textContent = "Agotado";
      } else if(p.stock > 0){
        const b = document.createElement("span");
        b.className="badge-chip";
        b.textContent=`Stock: ${p.stock}`;
        badges.appendChild(b);
      }

      body.append(h4, pdesc, price, actions);
      card.append(img, body, badges);
      frag.appendChild(card);
    });

    els.grid.appendChild(frag);
  }

  /* ==== Modal Detalles con Galer√≠a ==== */
  const modal = (()=>{
    const wrap = document.createElement('div');
    wrap.className='modal';
    wrap.innerHTML = `
      <div class="modal__card">
        <div class="gallery">
          <div class="gallery-main"><img id="g-main" alt="Producto" /></div>
          <div class="thumbs" id="g-thumbs"></div>
        </div>
        <div style="padding:8px 2px" id="g-info"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btn-ghost" id="g-close">Cerrar</button>
        </div>
      </div>`;
    document.body.appendChild(wrap);

    const main = ()=>wrap.querySelector('#g-main');
    const thumbs = ()=>wrap.querySelector('#g-thumbs');
    const info=()=>wrap.querySelector('#g-info');

    wrap.addEventListener('click',(e)=>{ if(e.target===wrap) close(); });
    wrap.querySelector('#g-close').onclick = ()=>close();

    function open(p){
      const imgs = (p.images && p.images.length ? p.images : [p.imagen]).filter(Boolean);
      main().src = imgs[0]||'';

      thumbs().innerHTML = imgs.map((u,i)=>`<img alt="${escapeHtml(p.nombre)} ${i+1}" data-src="${escapeAttr(u)}" class="${i===0?'active':''}">`).join('');
      thumbs().querySelectorAll('img').forEach(t=>{
        t.onclick = ()=>{
          main().src = t.dataset.src;
          thumbs().querySelectorAll('img').forEach(x=>x.classList.remove('active'));
          t.classList.add('active');
        };
      });

      const links = [];
      if(p.links?.instagram) links.push(`<a class="btn btn-ghost" href="${escapeAttr(p.links.instagram)}" target="_blank" rel="noopener">Instagram</a>`);
      if(p.links?.facebook)  links.push(`<a class="btn btn-ghost" href="${escapeAttr(p.links.facebook)}" target="_blank" rel="noopener">Facebook</a>`);
      if(p.links?.whatsapp)  links.push(`<a class="btn btn-primary glow" href="${escapeAttr(p.links.whatsapp)}" target="_blank" rel="noopener">WhatsApp</a>`);

      info().innerHTML = `
        <h3 style="margin:.3rem 0 0">${escapeHtml(p.nombre)}</h3>
        <div style="color:var(--muted)">${escapeHtml(p.desc||"")}</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          ${links.join("")}
        </div>
      `;

      wrap.classList.add('open');
    }
    function close(){ wrap.classList.remove('open'); }

    return { open, close };
  })();

  function showDetails(p){ modal.open(p); }

  /* ==== Carrito ==== */
  function loadCart(){ try{ return JSON.parse(localStorage.getItem("sdc_cart")||"[]"); }catch{ return []; } }
  function saveCart(){ localStorage.setItem("sdc_cart", JSON.stringify(state.cart)); updateCartCount(); }
  function updateCartCount(){ els.cartCount.textContent = state.cart.reduce((a,i)=>a+i.qty,0); }

  function addToCart(p){
    const id = (p.sheet||"") + "::" + p.nombre;
    const idx = state.cart.findIndex(i=>i.id===id);
    const price = (p.promo>0 && p.promo<p.precio ? p.promo : p.precio);
    if(idx>=0) state.cart[idx].qty = clamp(state.cart[idx].qty+1,1,99);
    else state.cart.push({ id, nombre:p.nombre, precio:price, imagen:(p.images&&p.images[0])||p.imagen, qty:1 });
    saveCart();
    openDrawer();
    renderCart();
    toast("A√±adido al carrito ‚úÖ");
  }

  function removeFromCart(id){ state.cart = state.cart.filter(i=>i.id!==id); saveCart(); renderCart(); }
  function changeQty(id,delta){ const it = state.cart.find(i=>i.id===id); if(!it) return; it.qty = clamp(it.qty + delta, 1, 99); saveCart(); renderCart(); }

  function renderCart(){
    els.cartList.innerHTML = "";
    if(state.cart.length === 0){
      els.cartList.innerHTML = "<li style='padding:8px;color:var(--muted)'>Tu carrito est√° vac√≠o.</li>";
    }else{
      state.cart.forEach(i=>{
        const li = document.createElement("li");
        li.className="cart-item";

        const img = document.createElement("img");
        img.src = i.imagen || "";
        img.alt = i.nombre;

        const info = document.createElement("div");
        info.innerHTML = `<b>${escapeHtml(i.nombre)}</b><div style="color:var(--muted)">${money(i.precio)}</div>`;

        const right = document.createElement("div");
        right.innerHTML = `
          <div class="qty">
            <button class="btn btn-ghost" aria-label="Menos">-</button>
            <span>${i.qty}</span>
            <button class="btn btn-ghost" aria-label="M√°s">+</button>
          </div>
          <button class="btn btn-ghost" style="margin-top:6px">Eliminar</button>
        `;
        const btns = right.querySelectorAll("button");
        const btnMinus = btns[0];
        const btnPlus  = btns[1];
        const btnDel   = btns[2];
        btnMinus.onclick = ()=>changeQty(i.id,-1);
        btnPlus.onclick = ()=>changeQty(i.id,1);
        btnDel.onclick = ()=>removeFromCart(i.id);

        li.append(img, info, right);
        els.cartList.appendChild(li);
      });
    }
    computeTotals();
  }

  /* ==== Shipping Advanced (desde hoja "envios") ==== */
  function normalizeModalidad(v){
    const s = (v||"").toString().toLowerCase();
    if(s.includes("contra") || s.includes("recibir") || s.includes("entrega")) return "PAGAR AL RECIBIR";
    return "Prepago";
  }

  async function loadShippingAdvanced(){
    let rows = null;
    let picked = null;

    for(const name of CONFIG.SHEET_SHIPPING_CANDIDATES){
      try{
        rows = await fetchSheetRows(name);
        picked = name;
        break;
      }catch(e){}
    }
    if(!rows) throw new Error("No existe la hoja envios o no est√° publicada.");

    const norm = v => (v||"").toString().trim();

    state.shippingMap = {};
    rows.forEach(r=>{
      const empresa   = norm(r.empresa || r.Empresa || r.shipper || r.Shipper) || "Local";
      const area      = norm(r.area || r.Area || r.departamento || r.Departamento) || "Comayagua";
      const zona      = norm(r.zona || r.Zona) || "__ANY__";
      const modalidad = normalizeModalidad(r.modalidad || r.Modalidad || r.pago || r.Pago);
      const colonias  = norm(r.colonias || r.Colonias);
      const tarifaNum = parseMoney(r.tarifa || r.Tarifa || r.precio || r.Precio);

      state.shippingMap[empresa] = state.shippingMap[empresa] || {};
      state.shippingMap[empresa][area] = state.shippingMap[empresa][area] || {};
      state.shippingMap[empresa][area][zona] = state.shippingMap[empresa][area][zona] || {};
      state.shippingMap[empresa][area][zona][modalidad] = {
        tarifa: tarifaNum,
        colonias: colonias ? colonias.split(",").map(s=>s.trim().toLowerCase()).filter(Boolean) : []
      };
    });

    populateZoneOptions();
  }

  function populateZoneOptions(){
    const mapLocal = (state.shippingMap["Local"] || {})["Comayagua"] || {};
    const zonas = Object.keys(mapLocal).filter(z=>z!=="__ANY__");
    els.zoneSel.innerHTML = (zonas.length ? zonas : ["Centrica","Alejada"]).map(z=>`<option value="${escapeAttr(z)}">${escapeHtml(z)}</option>`).join("");
  }

  function detectZoneFromAddress(addr){
    const addrLow = (addr||"").toLowerCase();
    const areaMap = ((state.shippingMap["Local"] || {})["Comayagua"]) || {};
    for(const zona of Object.keys(areaMap)){
      const modMap = areaMap[zona] || {};
      for(const modalidad of Object.keys(modMap)){
        const { colonias } = modMap[modalidad] || {};
        if(colonias && colonias.length){
          if(colonias.some(c => c && addrLow.includes(c))) return zona;
        }
      }
    }
    return null;
  }

  function syncCheckoutUI(){
    const formData = new FormData(els.checkoutForm);
    const isLocal = (formData.get("isComayagua") || "si") === "si";

    // Mostrar/ocultar zona
    els.zoneField.style.display = isLocal ? "" : "none";

    // Opciones de env√≠o
    if(isLocal){
      els.shipper.innerHTML = `
        <option value="Local">Reparto Local</option>
        <option value="C807">C807</option>
        <option value="Cargo Expreso">Cargo Expreso</option>
        <option value="Forza">Forza</option>
      `;
      els.shipper.value = "Local";
    }else{
      els.shipper.innerHTML = `
        <option value="">Selecciona‚Ä¶</option>
        <option value="C807">C807</option>
        <option value="Cargo Expreso">Cargo Expreso</option>
        <option value="Forza">Forza</option>
      `;
      if(els.shipper.value === "Local") els.shipper.value = "";
    }

    // Defaults de ubicaci√≥n si es Comayagua
    if(isLocal){
      if(!els.dept.value.trim()) els.dept.value = "Comayagua";
      if(!els.muni.value.trim()) els.muni.value = "Comayagua";
    }
    computeTotals();
  }

  function computeTotals(){
    const subtotal = state.cart.reduce((a,i)=>a + i.precio*i.qty, 0);
    let discount = 0;

    if(state.couponApplied){
      const c = state.couponApplied;
      if(subtotal >= (c.min||0)){
        discount = (c.tipo==='percent') ? (subtotal * (c.valor/100)) : c.valor;
        discount = Math.min(discount, subtotal);
      }
    }

    const subAfter = Math.max(0, subtotal - discount);

    els.subtotal.textContent = money(subtotal);
    if(discount>0){
      els.discountRow.classList.remove('hidden');
      els.discount.textContent = '- ' + money(discount);
    }else{
      els.discountRow.classList.add('hidden');
    }

    const formData = new FormData(els.checkoutForm);
    const isLocal = (formData.get("isComayagua") || "si") === "si";
    const empresa = (isLocal ? "Local" : (els.shipper.value || ""));
    const modalidad = normalizeModalidad(formData.get("payMode") || "Prepago");
    const addr = els.addr.value || "";
    const dept = els.dept.value.trim();
    const muni = els.muni.value.trim();

    let shipText = "A calcular";
    let shipCost = 0;
    let okToOrder = true;

    if(isLocal){
      // Autodetect zona (si hay colonias configuradas), sino usa el selector
      let zona = detectZoneFromAddress(addr) || (els.zoneSel.value || "Centrica");

      const areaMap = ((state.shippingMap["Local"] || {})["Comayagua"]) || {};
      const zoneMap = areaMap[zona] || areaMap["__ANY__"] || {};
      const rule = zoneMap[modalidad] || zoneMap["Prepago"] || null;

      if(rule){
        shipCost = Number(rule.tarifa || 0);
        shipText = money(shipCost);
      }else{
        shipText = "A calcular";
      }
    }else{
      // ‚úÖ CORRECCI√ìN: fuera de Comayagua debe escoger empresa antes de enviar
      if(!empresa){
        okToOrder = false;
        shipText = "Selecciona empresa";
      }else{
        const empresaMap = state.shippingMap[empresa] || {};
        const areaMap = empresaMap[dept] || empresaMap[muni] || empresaMap["Fuera de Comayagua"] || empresaMap["Honduras"] || empresaMap["HN"] || {};
        const zoneMap = areaMap["__ANY__"] || areaMap["Orillas"] || areaMap["General"] || {};
        const rule = zoneMap[modalidad] || zoneMap["PAGAR AL RECIBIR"] || zoneMap["Prepago"] || null;

        shipCost = Number(rule?.tarifa || 0);

        // Si la tarifa es 0, lo tratamos como "lo cobra la empresa" (no suma al total)
        if(shipCost <= 0){
          shipText = "Pagar al recibir (lo cobra la empresa)";
          shipCost = 0;
        }else{
          shipText = money(shipCost);
        }
      }
    }

    els.shipping.textContent = shipText;

    const grand = subAfter + shipCost;
    els.grand.textContent = money(grand);

    // Deshabilitar bot√≥n WhatsApp si falta empresa fuera de Comayagua o carrito vac√≠o
    const btn = document.getElementById("btn-whatsapp");
    if(btn){
      btn.disabled = !okToOrder || state.cart.length === 0;
      btn.style.opacity = btn.disabled ? 0.6 : 1;
    }
  }

  function buildWhatsAppText(){
    const lines = [];
    lines.push("*Nuevo pedido ‚Äî SDC*");
    lines.push("");

    state.cart.forEach(i=>{
      lines.push(`‚Ä¢ ${i.nombre} x${i.qty} ‚Äî ${money(i.precio*i.qty)}`);
    });

    lines.push("");
    lines.push(`Subtotal: ${els.subtotal.textContent}`);
    if(!els.discountRow.classList.contains('hidden')){
      lines.push(`Descuento: ${els.discount.textContent.replace('- ','-')}`);
    }

    const formData = new FormData(els.checkoutForm);
    const isLocal = (formData.get("isComayagua") || "si") === "si" ? "S√≠" : "No";
    const payMode = normalizeModalidad(formData.get("payMode") || "Prepago");
    const shipper = (isLocal==="S√≠") ? "Reparto Local" : (els.shipper.value || "Por confirmar");

    lines.push(`Env√≠o: ${els.shipping.textContent} (${shipper})`);
    lines.push(`¬øEn Comayagua?: ${isLocal}`);
    lines.push(`Pago: ${payMode}`);

    const addr = els.addr.value.trim();
    const dept = els.dept.value.trim();
    const muni = els.muni.value.trim();

    if(addr) lines.push(`Direcci√≥n: ${addr}`);
    if(dept) lines.push(`Depto.: ${dept}`);
    if(muni) lines.push(`Municipio: ${muni}`);

    lines.push(`Total: ${els.grand.textContent}`);
    lines.push("");

    if(state.couponApplied){
      lines.push(`Cup√≥n usado: ${state.couponApplied.code}`);
    }
    lines.push("¬°Gracias! üôå");

    return encodeURIComponent(lines.join("\n"));
  }

  function goWhatsApp(){
    if(state.cart.length === 0){
      toast("Tu carrito est√° vac√≠o.");
      return;
    }
    const formData = new FormData(els.checkoutForm);
    const isLocal = (formData.get("isComayagua") || "si") === "si";
    if(!isLocal && !els.shipper.value){
      toast("Selecciona empresa de env√≠o üëá");
      return;
    }
    if(!els.addr.value.trim()){
      toast("Escribe tu direcci√≥n exacta üè†");
      return;
    }
    const url = `https://wa.me/${CONFIG.WHATSAPP_NUMBER}?text=${buildWhatsAppText()}`;
    window.open(url, "_blank", "noopener");
  }

  /* ==== Coupons (opcional) ==== */
  async function loadCoupons(){
    let rows = null;
    for(const name of CONFIG.SHEET_COUPONS_CANDIDATES){
      try{ rows = await fetchSheetRows(name); break; }catch(e){}
    }
    if(!rows) { state.coupons = {}; return; }
    rows.forEach(r=>{
      const code = (r.code||r.codigo||r.CODIGO||"").toString().trim().toUpperCase();
      if(!code) return;
      const tipo = (r.tipo||"percent").toString().toLowerCase();
      const valor = parseMoney(r.valor||"0");
      const activo = String(r.activo||r.activa||"si").toLowerCase().startsWith('s');
      const min = parseMoney(r.min_subtotal||"0");
      const exp = (r.expires||r.expira||"").toString().trim();
      state.coupons[code] = { tipo, valor, activo, min, exp };
    });
  }

  function applyCoupon(code){
    code = (code||"").toUpperCase().trim();
    if(!code){ state.couponApplied=null; computeTotals(); toast('Sin cup√≥n'); return; }

    const c = state.coupons[code];
    if(!c || !c.activo){ toast('Cup√≥n inv√°lido o inactivo'); return; }

    if(c.exp){
      const now = new Date();
      const expD = new Date(c.exp + 'T23:59:59');
      if(isFinite(expD) && now > expD){ toast('Cup√≥n expirado'); return; }
    }
    state.couponApplied = { code, ...c };
    toast(`Cup√≥n aplicado: ${code}`);
    computeTotals();
  }

  /* ==== Drawer ==== */
  function openDrawer(){
    els.drawer.classList.add("open");
    els.overlay.classList.add("show");
    els.drawer.setAttribute("aria-hidden","false");
  }
  function closeDrawer(){
    els.drawer.classList.remove("open");
    els.overlay.classList.remove("show");
    els.drawer.setAttribute("aria-hidden","true");
  }

  /* ==== Events ==== */
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

  ["input","change"].forEach(ev=>{
    els.q.addEventListener(ev, debounce(applyFilters, 180));
    els.cat.addEventListener(ev, applyFilters);
    els.priceMin.addEventListener(ev, applyFilters);
    els.priceMax.addEventListener(ev, applyFilters);
    els.onlyOffers.addEventListener(ev, applyFilters);
  });

  document.getElementById("btn-cart").onclick = ()=>{ openDrawer(); renderCart(); };
  document.getElementById("close-drawer").onclick = closeDrawer;
  document.getElementById("overlay").onclick = closeDrawer;
  document.getElementById("scroll-search").onclick = ()=>document.getElementById("buscar").scrollIntoView({behavior:"smooth"});

  els.shipper.addEventListener("change", computeTotals);
  els.checkoutForm.addEventListener("change", ()=>{ syncCheckoutUI(); });
  els.addr.addEventListener("input", debounce(computeTotals, 240));

  els.checkoutForm.addEventListener("submit", (e)=>{ e.preventDefault(); goWhatsApp(); });
  els.btnApplyCoupon.onclick = ()=>applyCoupon(els.coupon.value);

  // Ofertas CTA
  if(els.btnViewOffers){
    els.btnViewOffers.onclick = ()=>{
      els.onlyOffers.checked = true;
      applyFilters();
      document.getElementById("catalogo").scrollIntoView({behavior:"smooth"});
      toast("Mostrando solo ofertas üî•");
    };
  }

  // Theme
  els.btnTheme.onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur==='nightcity'?'cyberpunk':'nightcity';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('sdc_theme', next);
  };

  // Restore theme
  const savedTheme = localStorage.getItem('sdc_theme');
  if(savedTheme){ document.documentElement.setAttribute('data-theme', savedTheme); }

  // Small sanitizers
  function escapeHtml(s){
    return (s??"").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
  }
  function escapeAttr(s){ return escapeHtml(s).replace(/`/g,"&#096;"); }

  // Start
  updateCartCount();
  loadData();
  
  // Privacy accordion: open when navigating to #privacidad
  (function(){
    const privacy = document.getElementById("privacidad");
    if(!privacy) return;

    function openIfHash(){
      if(location.hash === "#privacidad"){
        privacy.open = true;
        setTimeout(()=>privacy.scrollIntoView({behavior:"smooth", block:"start"}), 50);
      }
    }

    window.addEventListener("hashchange", openIfHash);
    document.querySelectorAll('a[href="#privacidad"]').forEach(a=>{
      a.addEventListener("click", ()=>setTimeout(openIfHash, 0));
    });

    openIfHash();
  })();
</script>
</body>

</html>
